<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éŸ³æ¥½ã‚²ãƒ¼ãƒ ã‚¹ã‚³ã‚¢ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, doc, setDoc, getDoc, getDocs, deleteDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Firebaseè¨­å®šï¼ˆã‚ãªãŸã®è¨­å®šå€¤ã«ç½®ãæ›ãˆã¦ãã ã•ã„ï¼‰
        const firebaseConfig = {
            apiKey: "AIzaSyBrlOj1D_Tkk16l9_T_gHcGgGvgjXrkg2k",
            authDomain: "tcdb-de19d.firebaseapp.com",
            projectId: "tcdb-de19d",
            storageBucket: "tcdb-de19d.firebasestorage.app",
            messagingSenderId: "914426625733",
            appId: "1:914426625733:web:1d167f8648e40268a2baac",
            measurementId: "G-W8N9ZDFT6Y"
        };

        const DIFFICULTIES = ['NORMAL', 'HARD', 'MASTER', 'INSANITY', 'RAVAGE'];
        const DIFFICULTY_COLORS = ['bg-sky-400', 'bg-amber-500', 'bg-purple-600', 'bg-slate-400', 'bg-red-600'];

        let app, auth, db, currentUser, isAdmin = false;
        let songs = [], userScores = {};
        let currentPage = 'score';
        let selectedSong = null;
        let editingSong = null;

        // FirebaseåˆæœŸåŒ–
        async function initFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å…¬é–‹ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
                window.auth = auth;
                window.db = db;

                // åŒ¿åèªè¨¼
                await signInAnonymously(auth);

                // èªè¨¼çŠ¶æ…‹ã®ç›£è¦–
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        currentUser = user;
                        window.currentUser = user; // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å…¬é–‹
                        
                        // ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’è¡¨ç¤º
                        displayUserId(user.uid);
                        
                        document.getElementById('loading').classList.add('hidden');
                        document.getElementById('app').classList.remove('hidden');
                        await loadUserData(user.uid);
                        await loadSongs();
                        renderCurrentPage();
                    }
                });
            } catch (error) {
                console.error("FirebaseåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:", error);
                document.getElementById('loading').innerHTML = `
                    <div class="text-white text-center">
                        <div class="text-2xl mb-4">FirebaseåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼</div>
                        <div class="text-sm bg-red-500 bg-opacity-20 p-4 rounded-lg max-w-2xl mx-auto">
                            ${error.message}
                        </div>
                        <div class="text-sm mt-4">firebaseConfigã‚’ç¢ºèªã—ã¦ãã ã•ã„</div>
                    </div>
                `;
            }
        }

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼IDè¡¨ç¤º
        function displayUserId(uid) {
            const display = document.getElementById('userIdDisplay');
            if (display) {
                display.innerHTML = `
                    <div class="bg-yellow-500 bg-opacity-20 px-3 py-2 rounded-lg">
                        <span class="text-yellow-300 text-xs">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ID:</span>
                        <span class="text-yellow-100 font-mono text-sm ml-2">éè¡¨ç¤º</span>
                        <button onclick="copyUserId('${uid}')" class="ml-2 bg-yellow-600 hover:bg-yellow-700 text-white text-xs px-2 py-1 rounded">
                            ã‚³ãƒ”ãƒ¼
                        </button>
                    </div>
                `;
            }
        }

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚³ãƒ”ãƒ¼
        window.copyUserId = (uid) => {
            navigator.clipboard.writeText(uid).then(() => {
                alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼\n\nFirestoreã® users ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã§\nã“ã®IDã‚’ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆIDã¨ã—ã¦ä½¿ç”¨ã—ã€\nisAdmin: true ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚');
            });
        };

        // æ¥½æ›²ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
        async function loadSongs() {
            try {
                const songsCol = collection(db, 'songs');
                const songSnapshot = await getDocs(songsCol);
                songs = songSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                songs.sort((a, b) => a.title.localeCompare(b.title, 'ja'));
                window.songs = songs; // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å…¬é–‹
            } catch (error) {
                console.error("æ¥½æ›²èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:", error);
            }
        }

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ï¼ˆã‚µãƒ–ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³æ§‹é€ ã«å¤‰æ›´ï¼‰
        async function loadUserData(userId) {
            try {
                const userDoc = await getDoc(doc(db, 'users', userId));
                if (userDoc.exists() && userDoc.data().isAdmin) {
                    isAdmin = true;
                    window.isAdmin = true;
                    document.getElementById('adminTab').classList.remove('hidden');
                }

                // ã‚µãƒ–ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‹ã‚‰ç›´æ¥ã‚¹ã‚³ã‚¢ã‚’å–å¾—ï¼ˆé«˜é€Ÿï¼‰
                const scoresCol = collection(db, 'users', userId, 'scores');
                const scoreSnapshot = await getDocs(scoresCol);
                userScores = {};
                scoreSnapshot.docs.forEach(doc => {
                    userScores[doc.id] = doc.data();
                });
                window.userScores = userScores;
                console.log(`${scoreSnapshot.docs.length}ä»¶ã®ã‚¹ã‚³ã‚¢ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ`);
            } catch (error) {
                console.error("ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:", error);
            }
        }

        // å˜æ›²ãƒ¬ãƒ¼ãƒˆè¨ˆç®—
        function calculateRate(score, level) {
            const baseRate = level;
            const scoreRate = score >= 999000 ? (level + (2 + (score - 999000) / 10000)) / 34 :
                             score >= 995000 ? (level + (1.5 + (score - 995000) / 8000)) / 34 :
                             score >= 990000 ? (level + (1 + (score - 990000) / 10000)) / 34 :
                             score >= 970000 ? (level + (score - 970000) / 20000) / 34 :
                             score >= 800000 ? (level * (score - 800000) / 170000) / 34 : 0;
            return (scoreRate).toFixed(3);
        }

        // ã‚¹ã‚³ã‚¢ä¿å­˜ï¼ˆã‚µãƒ–ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³æ§‹é€ ï¼‰
async function saveScore(songId, difficulty, score, level) {
  const rate = calculateRate(parseInt(score), parseFloat(level));
  const scoreId = `${songId}_${difficulty}`;

  try {
    await setDoc(doc(db, 'users', currentUser.uid, 'scores', scoreId), {
      songId,
      difficulty,
      score: parseInt(score),
      level: parseFloat(level),
      rate: parseFloat(rate),
      timestamp: new Date().toISOString()
    });

    // ãƒ­ãƒ¼ã‚«ãƒ«åæ˜ 
    userScores[scoreId] = { songId, difficulty, score: parseInt(score), level: parseFloat(level), rate: parseFloat(rate) };

    // âœ… ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ï¼ˆä¸€è¦§ã«æˆ»ã•ãªã„ï¼‰
    showToast('ã‚¹ã‚³ã‚¢ã‚’ä¿å­˜ã—ã¾ã—ãŸ', 'success');

    // æ¬¡ã®é›£æ˜“åº¦ã‚’å…¥ã‚Œã‚„ã™ã„ã‚ˆã†å…¥åŠ›çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
    window.selectedDifficulty = null;
    window.selectedLevel = null;
    const input = document.getElementById('scoreInput');
    if (input) input.value = '';

    // é›£æ˜“åº¦ãƒœã‚¿ãƒ³ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆè§£é™¤ & å…¥åŠ›æ¬„ã‚’ä¸€æ—¦éš ã™
    if (typeof DIFFICULTIES !== 'undefined') {
      DIFFICULTIES.forEach(d => {
        const btn = document.getElementById(`diff_${d}`);
        if (btn) { btn.classList.remove('bg-opacity-100'); btn.classList.add('bg-opacity-50'); }
      });
    }
    const inputs = document.getElementById('scoreInputs');
    if (inputs) inputs.classList.add('hidden');

    // ç”»é¢ã¯ã‚¹ã‚³ã‚¢ç™»éŒ²ã®ã¾ã¾ï¼ˆåŒã˜æ›²ï¼‰ã€‚å¿…è¦ãªã‚‰å†æç”»ã ã‘è¡Œã†
    if (currentPage === 'score' && selectedSong && selectedSong.id === songId) {
      const content = document.getElementById('content');
      if (typeof renderScoreEntry === 'function' && content) renderScoreEntry(content);
    }
  } catch (error) {
    console.error('ã‚¹ã‚³ã‚¢ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
    showToast('ã‚¹ã‚³ã‚¢ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
  }
}

        // ã‚¹ã‚³ã‚¢å‰Šé™¤
        async function deleteScore(scoreId) {
            if (!confirm('ã“ã®ã‚¹ã‚³ã‚¢ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
            
            try {
                await deleteDoc(doc(db, 'users', currentUser.uid, 'scores', scoreId));
                delete userScores[scoreId];
                showToast('æ¥½æ›²ã‚’ä¿å­˜ã—ã¾ã—ãŸ', 'success')
                renderCurrentPage();
            } catch (error) {
                console.error("ã‚¹ã‚³ã‚¢å‰Šé™¤ã‚¨ãƒ©ãƒ¼:", error);
                alert('ã‚¹ã‚³ã‚¢ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        // æ¥½æ›²ä¿å­˜ï¼ˆç”»åƒURLæ–¹å¼ã«å¤‰æ›´ï¼‰
        async function saveSong(songData) {
            const songId = songData.id || `song_${Date.now()}`;
            const imageUrl = document.getElementById('imageUrlInput')?.value || songData.imageUrl || '';

            try {
                console.log('æ¥½æ›²ãƒ‡ãƒ¼ã‚¿ä¿å­˜é–‹å§‹...');
                await setDoc(doc(db, 'songs', songId), {
                    title: songData.title,
                    artist: songData.artist,
                    difficulties: songData.difficulties,
                    imageUrl: imageUrl,
                    createdAt: songData.createdAt || new Date().toISOString(),
                    updatedAt: new Date().toISOString(),
                    tags: Array.isArray(songData.tags) ? songData.tags : []
                });
                console.log('æ¥½æ›²ãƒ‡ãƒ¼ã‚¿ä¿å­˜å®Œäº†');

                await loadSongs();
                editingSong = null;
                showToast('æ¥½æ›²ã‚’ä¿å­˜ã—ã¾ã—ãŸ', 'success')
                renderCurrentPage();
            } catch (error) {
                console.error("æ¥½æ›²ä¿å­˜ã‚¨ãƒ©ãƒ¼:", error);
                throw error;
            }
        }

        // æ¥½æ›²å‰Šé™¤ï¼ˆã‚·ãƒ³ãƒ—ãƒ«åŒ–ï¼‰
        async function deleteSong(songId) {
            if (!confirm('æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;

            try {
                await deleteDoc(doc(db, 'songs', songId));
                await loadSongs();
                alert('æ¥½æ›²ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
                renderCurrentPage();
            } catch (error) {
                console.error("æ¥½æ›²å‰Šé™¤ã‚¨ãƒ©ãƒ¼:", error);
            }
        }

        // ãƒšãƒ¼ã‚¸åˆ‡ã‚Šæ›¿ãˆ
        function switchPage(page) {
          currentPage = page;
          selectedSong = null;
          editingSong = null;

          document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.classList.remove('bg-white', 'bg-opacity-20', 'text-white', 'text-purple-900');
            btn.classList.add('bg-white', 'bg-opacity-20', 'text-white');
          });

  const active = document.getElementById(`${page}Tab`);
  if (active) {
    active.classList.remove('bg-opacity-20', 'text-white');
    active.classList.add('bg-white', 'text-purple-900');
  }
  renderCurrentPage();
}

        // æ¥½æ›²è¿½åŠ é–‹å§‹
        window.startAddSong = () => {
            editingSong = {};
            renderCurrentPage();
        };

        // ãƒšãƒ¼ã‚¸ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
        function renderCurrentPage() {
            const content = document.getElementById('content');
            
            if (currentPage === 'score') {
                if (selectedSong) {
                    renderScoreEntry(content);
                } else {
                    renderSongList(content);
                }
            } else if (currentPage === 'stats') {
                renderStatistics(content);
            } else if (currentPage === 'admin') {
                renderAdmin(content);
            }
        }

        // æ¥½æ›²ãƒªã‚¹ãƒˆè¡¨ç¤º
        // --- replace START: renderSongList ---
function renderSongList(container) {
  // è¡¨ç¤ºç”¨ï¼ˆå°æ–‡å­—åŒ–ã—ãªã„ï¼‰
  const domTerm = document.getElementById('searchInput')?.value || '';
  const rawTerm = (window.songSearchTerm ?? domTerm) || '';

  container.innerHTML = `
    <!-- æ¤œç´¢æ¬„ï¼ˆå›ºå®šã€‚ä»¥é™ã¯å†æç”»ã—ãªã„ï¼‰ -->
    <div class="mb-6">
  <div class="relative">
    <!-- ğŸ” å·¦ã‚¢ã‚¤ã‚³ãƒ³ -->
    <svg
      aria-hidden="true"
      class="pointer-events-none absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-500 z-10"
      viewBox="0 0 24 24" fill="none" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M21 21l-4.35-4.35M10.5 18a7.5 7.5 0 110-15 7.5 7.5 0 010 15z"/>
    </svg>

    <!-- å…¥åŠ›æ¬„ï¼ˆå·¦ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã¯ã‚¢ã‚¤ã‚³ãƒ³å¹…ï¼‹ä½™ç™½åˆ†ï¼‰ -->
    <input
      type="text"
      id="searchInput"
      placeholder="æ¥½æ›²åãƒ»ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆåãƒ»ã‚¿ã‚°ã§æ¤œç´¢"
      class="w-full pl-12 pr-4 py-3 rounded-lg bg-white bg-opacity-90 backdrop-blur-sm text-gray-800 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-purple-500"
      value="${escapeHtml(rawTerm)}"
      oninput="handleSongSearch(this.value)"
      autocomplete="off"
      spellcheck="false"
      aria-label="æ¥½æ›²ã‚’æ¤œç´¢"
    />
  </div>
</div>

    <!-- æ¥½æ›²ã‚«ãƒ¼ãƒ‰ã®æŒ¿å…¥å…ˆï¼ˆã“ã“ã ã‘å‹•çš„ã«å…¥ã‚Œæ›¿ãˆã‚‹ï¼‰ -->
    <div id="songGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
  `;

  // åˆå›æç”»ï¼ˆæ¤œç´¢æ¬„ã¯å†æç”»ã—ãªã„ï¼‰
  fillSongGrid();
}
// --- replace END: renderSongList ---

        // --- add START: song search helpers ---
// æ­£è¦åŒ–ï¼ˆå¤§å°ï¼†å…¨åŠè§’ã®é•ã„ã‚’å¸åï¼‰
const _norm = s => (s || '').toString().toLowerCase().normalize('NFKC');

function _filterSongs(rawTerm) {
  const q = _norm(rawTerm);
  return songs.filter(song => {
    const t = _norm(song.title);
    const a = _norm(song.artist);
    const tagsArr = Array.isArray(song.tags) ? song.tags : (song.tags ? [song.tags] : []);
    const tagHit = tagsArr.some(tag => _norm(tag).includes(q));
    return t.includes(q) || a.includes(q) || tagHit;
  });
}

function _renderSongTiles(arr) {
  return arr.map(song => `
    <div onclick="selectSong('${song.id}')" class="bg-white bg-opacity-90 backdrop-blur-sm rounded-lg overflow-hidden cursor-pointer hover:bg-opacity-100 transition transform hover:scale-105 shadow-lg">
      ${song.imageUrl ? `
        <div class="w-full h-48 bg-gray-200 overflow-hidden">
          <img src="${song.imageUrl}" alt="${escapeHtml(song.title)}" class="w-full h-full object-cover" />
        </div>
      ` : `
        <div class="w-full h-48 bg-gradient-to-br from-purple-400 to-pink-400 flex items-center justify-center">
          <svg class="w-20 h-20 text-white opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3"></path>
          </svg>
        </div>
      `}
      <div class="p-4">
        <h3 class="font-bold text-lg text-gray-800 mb-1 truncate">${escapeHtml(song.title)}</h3>
        <p class="text-sm text-gray-600 mb-3 truncate">${escapeHtml(song.artist)}</p>
        <div class="flex flex-wrap gap-1">
          ${DIFFICULTIES.map((diff, idx) =>
            song.difficulties?.[diff]
              ? `<span class="${DIFFICULTY_COLORS[idx]} text-white text-xs px-2 py-1 rounded font-semibold">${diff}</span>`
              : ''
          ).join('')}
        </div>
      </div>
    </div>
  `).join('');
}

function fillSongGrid() {
  const grid = document.getElementById('songGrid');
  if (!grid) return;
  const domTerm = document.getElementById('searchInput')?.value || '';
  const rawTerm = (window.songSearchTerm ?? domTerm) || '';
  const filtered = _filterSongs(rawTerm);
  grid.innerHTML = _renderSongTiles(filtered);
}
// --- add END: song search helpers ---
        
        // ã‚¹ã‚³ã‚¢å…¥åŠ›ç”»é¢
        function renderScoreEntry(container) {
            const song = selectedSong;
            container.innerHTML = `
                <div class="bg-white bg-opacity-90 backdrop-blur-sm rounded-lg p-6 max-w-2xl mx-auto">
                    <button type="button" onclick="goBackFromScore()" class="mb-4 text-purple-700 hover:text-purple-900 font-semibold">
                      â† æˆ»ã‚‹
                    </button>
                    
                    ${song.imageUrl ? `
                        <div class="mb-4 rounded-lg overflow-hidden">
                            <img src="${song.imageUrl}" alt="${escapeHtml(song.title)}" class="w-full h-64 object-cover" />
                        </div>
                    ` : ''}
                    
                    <h2 class="text-2xl font-bold text-gray-800 mb-2">${escapeHtml(song.title)}</h2>
                    <p class="text-gray-600 mb-6">${escapeHtml(song.artist)}</p>

                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">é›£æ˜“åº¦ã‚’é¸æŠ</label>
                            <div class="flex flex-wrap gap-2" id="difficultyButtons">
                                ${DIFFICULTIES.map((diff, idx) => 
                                    song.difficulties?.[diff] ? 
                                    `<button onclick="selectDifficulty('${diff}', ${song.difficulties[diff]})" class="${DIFFICULTY_COLORS[idx]} bg-opacity-50 hover:bg-opacity-100 text-white px-4 py-2 rounded-lg font-semibold transition" id="diff_${diff}">
                                        ${diff} ${Number(song.difficulties[diff]).toFixed(1)}
                                    </button>` 
                                    : ''
                                ).join('')}
                            </div>
                        </div>

                        <div id="scoreInputs" class="hidden space-y-4">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">ã‚¹ã‚³ã‚¢</label>
                                <input type="number" id="scoreInput" placeholder="1000000" min="0" max="1000000" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-purple-500" />
                            </div>

                            <button onclick="submitScore()" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 rounded-lg transition">
                                ã‚¹ã‚³ã‚¢ã‚’ä¿å­˜
                            </button>
                        </div>
                    </div>
                </div>
            `;
            setTimeout(() => {
              const input = document.getElementById('scoreInput');
              if (input) {
                input.addEventListener('input', () => {
                  let v = input.value.replace(/[^0-9]/g, '');
                  if (v === '') return;
                  let n = parseInt(v, 10);
                  if (n < 0) n = 0;
                  if (n > 1000000) n = 1000000;
                  input.value = n;
                });
              }
            },0);
        }

        // çµ±è¨ˆç”»é¢
        function renderStatistics(container) {
  // ---- ãƒ¡ãƒˆãƒªã‚¯ã‚¹è¨ˆç®—ï¼ˆä¸Šä½40ã®åˆè¨ˆãƒ»å¹³å‡ï¼‰ ----
  // ---- ãƒ¡ãƒˆãƒªã‚¯ã‚¹è¨ˆç®—ï¼ˆä¸Šä½40åˆè¨ˆãƒ»å¹³å‡ãƒ»B40ä¸‹é™ï¼‰ ----
const ratesRaw = Object.values(userScores).map(s => Number(s.rate));
const rates = ratesRaw.filter(n => !Number.isNaN(n));
const sorted = [...rates].sort((a, b) => b - a);   // é«˜ã„é †
const topRates = sorted.slice(0, 40);
const sumTop = topRates.reduce((a, b) => a + b, 0);

// ç·åˆãƒ¬ãƒ¼ãƒˆï¼ˆä¸Šä½40ã®åˆè¨ˆï¼‰
const totalRate = topRates.length > 0 ? sumTop.toFixed(3) : '0.000';

// ä¸Šä½40å¹³å‡ãƒ¬ãƒ¼ãƒˆï¼šç™»éŒ²ãŒ40æœªæº€ã§ã‚‚ã€Œæ®‹ã‚Šã¯0ã€ã¨ã¿ãªã—ã¦ 40 ã§å‰²ã‚‹
const avgRate = (sumTop / 40).toFixed(3);

// B40ä¸‹é™ï¼ˆ40ç•ªç›®ã®ãƒ¬ãƒ¼ãƒˆï¼‰ã€‚ç™»éŒ²ãŒ39ä»¥ä¸‹ãªã‚‰ 0.000
const b40Lower = sorted.length >= 40 ? sorted[39].toFixed(3) : '0.000';

  // ---- ã‚¹ã‚³ã‚¢è¡Œãƒ‡ãƒ¼ã‚¿ï¼ˆæ›²æƒ…å ±ã‚’ä»˜ä¸ã—ã¦ä¸¦ã¹æ›¿ãˆï¼‰----
  const songMap = Object.fromEntries(songs.map(s => [s.id, s]));
  const scoresWithSongInfo = Object.entries(userScores)
    .map(([id, sc]) => ({ ...sc, song: songMap[sc.songId], scoreId: id }))
    .sort((a, b) => b.rate - a.rate);

  // ---- æç”» ----
  container.innerHTML = `
    <!-- ä¸Šéƒ¨ãƒ¡ãƒˆãƒªã‚¯ã‚¹ï¼ˆã‚¹ãƒãƒ›2åˆ—ï¼SMä»¥ä¸Š4åˆ—ï¼‰ -->
<div class="grid grid-cols-2 sm:grid-cols-4 gap-3 mb-4">
  <div class="bg-white bg-opacity-90 rounded-lg p-3 shadow-sm text-center">
    <div class="text-xs text-gray-500">Rating</div>
    <div class="text-xl font-bold text-purple-700">${totalRate}</div>
  </div>

  <div class="bg-white bg-opacity-90 rounded-lg p-3 shadow-sm text-center">
    <div class="text-xs text-gray-500">B40å¹³å‡ãƒ¬ãƒ¼ãƒˆ</div>
    <div class="text-xl font-bold text-purple-700">${avgRate}</div>
  </div>

  <div class="bg-white bg-opacity-90 rounded-lg p-3 shadow-sm text-center">
    <div class="text-xs text-gray-500">B40ä¸‹é™</div>
    <div class="text-xl font-bold text-purple-700">${b40Lower}</div>
  </div>

  <div class="bg-white bg-opacity-90 rounded-lg p-3 shadow-sm text-center">
    <div class="text-xs text-gray-500">ç™»éŒ²ã‚¹ã‚³ã‚¢æ•°</div>
    <div class="text-xl font-bold text-purple-700">${Object.keys(userScores).length}</div>
  </div>
</div>

    <!-- ã‚¹ã‚³ã‚¢ä¸€è¦§ -->
    <div id="scoreList" class="space-y-2">
      ${
        scoresWithSongInfo.map((score, idx) => `
          ${scoresWithSongInfo.length > 40 && idx === 40 ? `
            <div class="relative my-3">
              <div class="border-t border-gray-300"></div>
              <div class="absolute -top-3 left-1/2 -translate-x-1/2 bg-white bg-opacity-90 px-3 text-xs text-gray-500">
                BEST 40
              </div>
            </div>
          ` : ''}

          <div class="flex flex-col sm:flex-row sm:items-center gap-3 p-3 bg-white bg-opacity-90 rounded-lg shadow-sm">
            <!-- å·¦: ã‚µãƒ ãƒ -->
            ${
              score.song?.imageUrl ? `
                <img src="${score.song.imageUrl}"
                     alt="${escapeHtml(score.song.title || '')}"
                     class="flex-shrink-0 w-14 h-14 sm:w-16 sm:h-16 object-cover rounded" />
              ` : `
                <div class="flex-shrink-0 w-14 h-14 sm:w-16 sm:h-16 bg-gradient-to-br from-purple-400 to-pink-400 rounded flex items-center justify-center">
                  <svg class="w-8 h-8 text-white opacity-60" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3"></path>
                  </svg>
                </div>
              `
            }

            <!-- ä¸­: ã‚¿ã‚¤ãƒˆãƒ«ç­‰ï¼ˆtruncate ã•ã›ã‚‹ãŸã‚ min-w-0ï¼‰ -->
            <div class="flex-1 min-w-0">
              <div class="font-semibold text-gray-800 truncate">${escapeHtml(score.song?.title || '(ä¸æ˜ãªæ›²)')}</div>
              <div class="text-xs sm:text-sm text-gray-600 truncate">
                ${escapeHtml(score.difficulty)} Lv.${Number(score.level).toFixed(1)}
              </div>
            </div>

            <!-- å³: å€¤ã¨å‰Šé™¤ï¼ˆãƒ¢ãƒã‚¤ãƒ«ã§ã¯ä¸‹æ®µã«å›ã‚‹ï¼smä»¥ä¸Šã¯å³ç«¯å›ºå®šï¼‰ -->
            <div class="flex items-center justify-between sm:justify-end gap-3 sm:ml-4 shrink-0 w-full sm:w-auto">
              <div class="text-right flex-1 sm:flex-none min-w-0">
                <div class="font-bold text-base sm:text-lg text-purple-700 leading-tight">Rate: ${score.rate}</div>
                <div class="text-xs sm:text-sm text-gray-600 leading-tight">${Number(score.score).toLocaleString()}</div>
              </div>
              <button
                class="px-3 py-2 bg-red-500 hover:bg-red-600 text-white text-xs sm:text-sm rounded-md transition shrink-0"
                title="å‰Šé™¤"
                onclick="deleteScore('${score.scoreId}')"
              >
                å‰Šé™¤
              </button>
            </div>
          </div>
        `).join('')
      }
    </div>
  `;
}

        // ç®¡ç†ç”»é¢
        function renderAdmin(container) {
            if (editingSong) {
                renderSongEditor(container);
            } else {
                container.innerHTML = `
                    <div class="space-y-6">
                        <div class="flex justify-between items-center">
                            <h2 class="text-2xl font-bold text-white">æ¥½æ›²ç®¡ç†</h2>
                            <button onclick="startAddSong()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg font-semibold transition">
                                + æ–°è¦è¿½åŠ 
                            </button>
                        </div>

                        <div class="bg-white bg-opacity-90 backdrop-blur-sm rounded-lg p-6">
                            <h3 class="text-xl font-bold text-gray-800 mb-4">ç™»éŒ²æ¥½æ›²ä¸€è¦§</h3>
                            ${songs.length === 0 ? `
                                <div class="text-center py-8 text-gray-500">
                                    <svg class="w-16 h-16 mx-auto mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3"></path>
                                    </svg>
                                    <p class="text-lg">æ¥½æ›²ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</p>
                                    <p class="text-sm mt-2">ã€Œæ–°è¦è¿½åŠ ã€ãƒœã‚¿ãƒ³ã‹ã‚‰æ¥½æ›²ã‚’è¿½åŠ ã—ã¦ãã ã•ã„</p>
                                </div>
                            ` : `
                                <div class="space-y-2">
                                    ${songs.map(song => `
                                        <div class="flex items-center gap-4 p-3 bg-gray-50 rounded-lg">
                                            ${song.imageUrl ? `
                                                <img src="${song.imageUrl}" alt="Preview" class="w-32 h-32 object-cover rounded-lg" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" />
                                                    <div class="w-32 h-32 bg-gray-200 rounded-lg items-center justify-center flex-shrink-0" style="display:none;">
                                                        <svg class="w-12 h-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                                        </svg>
                                                    </div>
                                                ` : `
                                                <div class="w-16 h-16 bg-gradient-to-br from-purple-400 to-pink-400 rounded flex items-center justify-center flex-shrink-0">
                                                    <svg class="w-8 h-8 text-white opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3"></path>
                                                    </svg>
                                                </div>
                                            `}
                                            <div class="flex-1 min-w-0">
                                                <div class="font-semibold text-gray-800 truncate">${escapeHtml(song.title)}</div>
                                                <div class="text-sm text-gray-600 truncate">${escapeHtml(song.artist)}</div>
                                                <div class="text-xs text-gray-500 truncate">${escapeHtml((song.tags || []).join(', '))}</div>
                                            </div>
                                            <div class="flex gap-2 flex-shrink-0">
                                                <button onclick='editSong(${JSON.stringify(song).replace(/'/g, "&apos;")})' class="p-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition">
                                                    ç·¨é›†
                                                </button>
                                                <button onclick="deleteSong('${song.id}')" class="p-2 bg-red-500 hover:bg-red-600 text-white rounded-lg transition">
                                                    å‰Šé™¤
                                                </button>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            `}
                        </div>
                    </div>
                `;
            }
        }

        // æ¥½æ›²ç·¨é›†ç”»é¢
        function renderSongEditor(container) {
            const song = editingSong;
            container.innerHTML = `
                <div class="bg-white bg-opacity-90 backdrop-blur-sm rounded-lg p-6 max-w-3xl mx-auto">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">${song.id ? 'æ¥½æ›²ç·¨é›†' : 'æ¥½æ›²è¿½åŠ '}</h3>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">ã‚¸ãƒ£ã‚±ãƒƒãƒˆç”»åƒ</label>
                            <div class="flex items-center gap-4">
                                ${song.imageUrl ? `
                                    <img src="${song.imageUrl}" alt="Preview" class="w-32 h-32 object-cover rounded-lg" />
                                ` : `
                                    <div id="previewImage" class="w-32 h-32 bg-gray-200 rounded-lg flex items-center justify-center flex-shrink-0">
                                        <svg class="w-12 h-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                        </svg>
                                    </div>
                                `}
                                <div class="flex-1">
                                    <input type="url" id="imageUrlInput" value="${song.imageUrl || ''}" oninput="updateImagePreview(this.value)" placeholder="https://example.com/image.jpg" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-purple-500" />
                                    <p class="text-xs text-gray-500 mt-1">ImgBBã€Imgurã€Googleãƒ‰ãƒ©ã‚¤ãƒ–ãªã©ã®ç”»åƒURLã‚’å…¥åŠ›</p>
                                </div>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">æ¥½æ›²å</label>
                            <input type="text" id="songTitle" value="${escapeHtml(song.title || '')}" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-purple-500" />
                        </div>

                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆ</label>
                            <input type="text" id="songArtist" value="${escapeHtml(song.artist || '')}" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-purple-500" />
                        </div>

                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">æ¤œç´¢ç”¨ã‚¿ã‚°ï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰</label>
                            <input
                                type="text"
                                id="songTags"
                                value="${escapeHtml((song.tags || []).join(', '))}"
                                placeholder="ä¾‹) Tag, ã‚¿ã‚°"
                                class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-purple-500"
                            />
                            <p class="text-xs text-gray-500 mt-1">
                                æ¤œç´¢ã®åˆ¥åãƒ»èª­ã¿ã‚’ç™»éŒ²ã§ãã¾ã™ã€‚ã‚«ãƒ³ãƒã§åŒºåˆ‡ã£ã¦è¤‡æ•°æŒ‡å®šï¼ˆä¾‹: <code>Over limit, ã‚ªãƒ¼ãƒãƒ¼ãƒªãƒŸãƒƒãƒˆ, â‰ </code>ï¼‰
                            </p>
                        </div>

                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">é›£æ˜“åº¦ãƒ¬ãƒ™ãƒ«</label>
                            <div class="grid grid-cols-2 md:grid-cols-5 gap-3">
                                ${DIFFICULTIES.map((diff, idx) => `
                                    <div>
                                        <label class="block text-xs font-semibold mb-1 ${DIFFICULTY_COLORS[idx]} text-white px-2 py-1 rounded">
                                            ${diff}
                                        </label>
                                        <input type="number" step="0.1" id="diff_${diff}" value="${song.difficulties?.[diff] || ''}" placeholder="æœªè¨­å®š" class="w-full px-3 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-purple-500" />
                                    </div>
                                `).join('')}
                            </div>
                        </div>

                        <div class="flex gap-3">
                            <button id="saveSongButton" onclick="submitSong()" class="flex-1 bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 rounded-lg transition disabled:opacity-50 disabled:cursor-not-allowed">
                                ä¿å­˜
                            </button>
                            <button onclick="cancelEditSong()" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 rounded-lg transition">
                                ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ›´æ–°
        // ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ›´æ–°ï¼ˆç½®ãæ›ãˆï¼‰
        window.updateImagePreview = (url) => {
          const preview = document.getElementById('previewImage');
          if (!preview) return;

          if (!url) {
            if (preview.tagName === 'IMG') {
              // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’å¢—ã‚„ã•ãªã„ã‚ˆã†ã€å…ˆã«éš£ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’é™¤å»
              const fallback = preview.nextElementSibling;
              if (fallback) fallback.remove();

              preview.outerHTML = `
                <div id="previewImage" class="w-32 h-32 bg-gray-200 rounded-lg flex items-center justify-center flex-shrink-0">
                  <svg class="w-12 h-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                  </svg>
                </div>`;
            }
            return;
          }

          if (preview.tagName === 'DIV') {
            preview.outerHTML = `<img id="previewImage" src="${url}" alt="Preview" class="w-32 h-32 object-cover rounded-lg"
              onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" />
              <div class="w-32 h-32 bg-gray-200 rounded-lg items-center justify-center flex-shrink-0" style="display:none;">
                <svg class="w-12 h-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                </svg>
              </div>`;
          } else {
            preview.src = url;
            preview.style.display = 'block';
            const fallback = preview.nextElementSibling;
            if (fallback) fallback.style.display = 'none';
          }
        };

    
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°
        window.selectSong = (songId) => {
            selectedSong = songs.find(s => s.id === songId);
            renderCurrentPage();
        };

        window.selectDifficulty = (diff, level) => {
          window.selectedDifficulty = diff;
          window.selectedLevel = Number(level);
          document.getElementById('scoreInputs').classList.remove('hidden');

          DIFFICULTIES.forEach(d => {
            const btn = document.getElementById(`diff_${d}`);
            if (!btn) return;
            if (d === diff) {
              btn.classList.remove('bg-opacity-50');
              btn.classList.add('bg-opacity-100');
            } else {
              btn.classList.remove('bg-opacity-100');
              btn.classList.add('bg-opacity-50');
            }
          });
        };

        // ã‚¹ã‚³ã‚¢ä¿å­˜ï¼ˆç½®ãæ›ãˆï¼‰
        // ã‚¹ã‚³ã‚¢ä¿å­˜ï¼ˆãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³å«ã‚€ï¼‰
window.submitScore = () => {
  const raw = document.getElementById('scoreInput').value;

  if (!window.selectedDifficulty) {
    showToast('é›£æ˜“åº¦ã‚’é¸æŠã—ã¦ãã ã•ã„', 'warn');
    return;
  }
  // 0ã€œ1,000,000ã«ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆã‚­ãƒ¼ãƒœãƒ¼ãƒ‰å…¥åŠ›å¯¾ç­–æ¸ˆã¿ã§ã‚‚æœ€çµ‚é˜²è¡›ï¼‰
  const scoreNum = Math.max(0, Math.min(1000000, parseInt(raw || '0', 10)));
  if (Number.isNaN(scoreNum)) {
    showToast('ã‚¹ã‚³ã‚¢ãŒæ•°å€¤ã§ã¯ã‚ã‚Šã¾ã›ã‚“', 'warn');
    return;
  }
  saveScore(selectedSong.id, window.selectedDifficulty, scoreNum, window.selectedLevel);
};

        window.goBackFromScore = () => {
          selectedSong = null;
          window.selectedDifficulty = null;
          window.selectedLevel = null;
          renderCurrentPage();
        };

        window.editSong = (song) => {
            editingSong = song;
            renderCurrentPage();
        };

        window.cancelEditSong = () => {
            editingSong = null;
            renderCurrentPage();
        };

        window.submitSong = async () => {
            const title = document.getElementById('songTitle').value;
            const artist = document.getElementById('songArtist').value;
            
            if (!title || !artist) {
                alert('ã‚¿ã‚¤ãƒˆãƒ«ã¨ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆã¯å¿…é ˆã§ã™');
                return;
            }

            const difficulties = {};
            DIFFICULTIES.forEach(diff => {
                const value = document.getElementById(`diff_${diff}`).value;
                if (value) difficulties[diff] = parseFloat(value);
            });

            const rawTags = (document.getElementById('songTags')?.value || '');
            const tags = rawTags
                .split(',')
                .map(s => s.trim())
                .filter(Boolean);

            // é›£æ˜“åº¦ãŒ1ã¤ã‚‚è¨­å®šã•ã‚Œã¦ã„ãªã„å ´åˆã®è­¦å‘Š
            if (Object.keys(difficulties).length === 0) {
                if (!confirm('é›£æ˜“åº¦ãŒ1ã¤ã‚‚è¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ã“ã®ã¾ã¾ä¿å­˜ã—ã¾ã™ã‹ï¼Ÿ')) {
                    return;
                }
            }

            // ä¿å­˜ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–ï¼ˆäºŒé‡é€ä¿¡é˜²æ­¢ï¼‰
            const saveButton = document.getElementById('saveSongButton');
            if (saveButton) {
                saveButton.disabled = true;
                saveButton.textContent = 'ä¿å­˜ä¸­...';
            }

            try {
                await saveSong({
                    ...editingSong,
                    title,
                    artist,
                    difficulties,
                    tags
                });
            } catch (error) {
                console.error('ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
                // ãƒœã‚¿ãƒ³ã‚’å…ƒã«æˆ»ã™
                if (saveButton) {
                    saveButton.disabled = false;
                    saveButton.textContent = 'ä¿å­˜';
                }
            }
        };

        window.deleteSong = deleteSong;
        window.deleteScore = deleteScore;
        window.renderCurrentPage = renderCurrentPage;

        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text?.toString().replace(/[&<>"']/g, m => map[m]) || '';
        }

        // åˆæœŸåŒ–
        initFirebase();

        // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆé–¢æ•°ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å…¬é–‹
        window.switchPage = switchPage;

        // è¿½åŠ ï¼šæ¤œç´¢å…¥åŠ›ãƒãƒ³ãƒ‰ãƒ©ï¼ˆãƒšãƒ¼ã‚¸å…¨ä½“ã‚’å†æç”»ã—ãªã„ï¼‰
        window.handleSongSearch = (v) => {
          // å°æ–‡å­—åŒ–ã›ãšãã®ã¾ã¾ä¿æŒï¼ˆè¡¨ç¤ºã®è¦‹ãŸç›®ãŒå´©ã‚Œãªã„ã‚ˆã†ã«ï¼‰
          window.songSearchTerm = v || '';
          // ã‚°ãƒªãƒƒãƒ‰ã ã‘ã‚’å·®ã—æ›¿ãˆã‚‹
          if (typeof fillSongGrid === 'function') fillSongGrid();
        };
        // --- toast: ä¸€æ™‚ãƒãƒŠãƒ¼è¡¨ç¤ºï¼ˆalert ã®ä»£æ›¿ï¼‰ ---
(function(){
  function ensureToastContainer() {
    let c = document.getElementById('toastContainer');
    if (!c) {
      c = document.createElement('div');
      c.id = 'toastContainer';
      c.className = 'fixed top-4 left-1/2 -translate-x-1/2 transform z-50 space-y-2';
      document.body.appendChild(c);
    }
    return c;
  }
  window.showToast = (msg, type='info', ms=1800) => {
    const c = ensureToastContainer();
    const bg = type==='success' ? 'bg-green-600'
            : type==='error'   ? 'bg-red-600'
            : type==='warn'    ? 'bg-amber-600'
            : 'bg-gray-800';
    const el = document.createElement('div');
    el.className = `${bg} text-white px-4 py-2 rounded-lg shadow-lg transition-opacity duration-300 opacity-0`;
    el.textContent = msg;
    c.appendChild(el);
    requestAnimationFrame(() => { el.style.opacity = '1'; });
    setTimeout(() => { el.style.opacity = '0'; setTimeout(() => el.remove(), 300); }, ms);
  };
})();
    </script>
</head>
<body class="min-h-screen bg-gradient-to-br from-purple-900 via-blue-900 to-indigo-900">
    <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢ -->
    <div id="loading" class="min-h-screen flex items-center justify-center">
        <div class="text-white text-2xl">ãƒ­ã‚°ã‚¤ãƒ³ä¸­...</div>
    </div>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒª -->
    <div id="app" class="hidden">
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <div class="bg-black bg-opacity-50 backdrop-blur-sm border-b border-white border-opacity-20">
            <div class="max-w-7xl mx-auto px-4 py-4">
                <div class="flex items-center justify-between flex-wrap gap-4">
                    <div>
                        <h1 class="text-2xl md:text-3xl font-bold text-white flex items-center gap-2">
                            <!-- æŠ½è±¡ã‚­ãƒ¥ãƒ¼ãƒ–ãƒ»ãƒ­ã‚´ï¼ˆå¼·åŒ–ç‰ˆï¼‰ -->
<svg viewBox="0 0 24 24" fill="none" stroke="currentColor"
     class="w-8 h-8 text-white" role="img" aria-label="App icon: cube+core">
  <!-- å¤–æ ã‚­ãƒ¥ãƒ¼ãƒ– -->
  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
        d="M12 2l8 4.5v11L12 22l-8-4.5v-11L12 2z"/>
  <!-- ä¸Šé¢ã®ã‚¨ãƒƒã‚¸ -->
  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
        d="M4 6.5l8 4 8-4"/>
  <!-- å†…å´ã®å°ã‚­ãƒ¥ãƒ¼ãƒ–ï¼ˆã‚³ã‚¢ï¼‰ -->
  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
        d="M12 8l4 2.25v4.5L12 17l-4-2.25v-4.5L12 8z"/>
  <!-- æ–œã‚ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆï¼ˆå³ä¸Šã¸æŠœã‘ã‚‹è»½ã„ã‚¢ã‚¯ã‚»ãƒ³ãƒˆï¼‰ -->
  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
        d="M12 8l4-2"/>
</svg>
                            TAKUMIÂ³ Player DB
                        </h1>
                        <div id="userIdDisplay" class="mt-2"></div>
                    </div>
                    <div class="flex gap-2 flex-wrap">
                        <button id="scoreTab" onclick="switchPage('score')" class="tab-btn px-4 py-2 rounded-lg font-semibold transition bg-white text-purple-900">
                            ã‚¹ã‚³ã‚¢ç™»éŒ²
                        </button>
                        <button id="statsTab" onclick="switchPage('stats')" class="tab-btn px-4 py-2 rounded-lg font-semibold transition bg-white bg-opacity-20 text-white hover:bg-opacity-30">
                            çµ±è¨ˆ
                        </button>
                        <button id="adminTab" onclick="switchPage('admin')" class="tab-btn hidden px-4 py-2 rounded-lg font-semibold transition bg-white bg-opacity-20 text-white hover:bg-opacity-30">
                            ç®¡ç†
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¨ãƒªã‚¢ -->
        <div class="max-w-7xl mx-auto px-4 py-8">
            <div id="content"></div>
        </div>
    </div>
</body>
</html>
