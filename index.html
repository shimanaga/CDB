<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CubicDB</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import {
      getAuth,
      signInAnonymously,
      onAuthStateChanged,
      onIdTokenChanged
    } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
    import {
      getFirestore,
      collection,
      doc,
      setDoc,
      getDoc,
      getDocs,
      deleteDoc
    } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "AIzaSyBrlOj1D_Tkk16l9_T_gHcGgGvgjXrkg2k",
      authDomain: "tcdb-de19d.firebaseapp.com",
      projectId: "tcdb-de19d",
      storageBucket: "tcdb-de19d.firebasestorage.app",
      messagingSenderId: "914426625733",
      appId: "1:914426625733:web:1d167f8648e40268a2baac",
      measurementId: "G-W8N9ZDFT6Y"
    };

    const DIFFICULTIES = ['NORMAL', 'HARD', 'MASTER', 'INSANITY', 'RAVAGE'];
    const DIFFICULTY_COLORS = ['bg-sky-400', 'bg-amber-500', 'bg-purple-600', 'bg-slate-400', 'bg-red-600'];

    let app, auth, db, currentUser, isAdmin = false;
    let songs = [], userScores = {};
    let currentPage = 'score';
    let selectedSong = null;
    let editingSong = null;
    let cachedPrimaryUid = null;

    function escapeHtml(text) {
      const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
      return text?.toString().replace(/[&<>"']/g, m => map[m]) || '';
    }

    (function(){
      function ensureToastContainer() {
        let c = document.getElementById('toastContainer');
        if (!c) {
          c = document.createElement('div');
          c.id = 'toastContainer';
          c.className = 'fixed top-4 left-1/2 -translate-x-1/2 transform z-50 space-y-2';
          document.body.appendChild(c);
        }
        return c;
      }
      window.showToast = (msg, type='info', ms=1800) => {
        const c = ensureToastContainer();
        const bg = type==='success' ? 'bg-green-600'
                : type==='error'   ? 'bg-red-600'
                : type==='warn'    ? 'bg-amber-600'
                : 'bg-gray-800';
        const el = document.createElement('div');
        el.className = `${bg} text-white px-4 py-2 rounded-lg shadow-lg transition-opacity duration-300 opacity-0`;
        el.textContent = msg;
        c.appendChild(el);
        requestAnimationFrame(() => { el.style.opacity = '1'; });
        setTimeout(() => { el.style.opacity = '0'; setTimeout(() => el.remove(), 300); }, ms);
      };
    })();

    function updateRatingColor(value) {
      const el = document.getElementById("ratingValue");
      if (!el) return;
      el.style = "";
      if (value < 5.0) el.style.color = "#333333";
      else if (value < 10.0) el.style.color = "#22d3e3";
      else if (value < 12.0) el.style.color = "#08c969";
      else if (value < 14.0) el.style.color = "#deda00";
      else if (value < 16.0) el.style.color = "#e3970b";
      else if (value < 18.0) el.style.color = "#d91c1c";
      else if (value < 19.0) el.style.color = "#a319d1";
      else {
        el.style.background = "linear-gradient(130deg, magenta, red)";
        el.style.webkitBackgroundClip = "text";
        el.style.webkitTextFillColor = "transparent";
        el.style.animation = "rainbow 6s linear infinite";
      }
    }
    const rainbowStyle = document.createElement("style");
    rainbowStyle.textContent = `@keyframes rainbow{0%{filter:hue-rotate(0deg);}100%{filter:hue-rotate(360deg);}}`;
    document.head.appendChild(rainbowStyle);

    function resetPrimaryUidCache() {
      cachedPrimaryUid = null;
      delete window.primaryUid;
    }

    async function resolvePrimaryUid(auth, db) {
      const u = auth.currentUser;
      if (!u) throw new Error("not signed in");
      if (cachedPrimaryUid) return cachedPrimaryUid;

      try {
        const snap = await getDoc(doc(db, "aliases", u.uid));
        if (snap.exists() && snap.data()?.active) {
          cachedPrimaryUid = snap.data()?.primaryUid || u.uid;
        } else {
          cachedPrimaryUid = u.uid;
        }
      } catch (e) {
        console.error("resolvePrimaryUid error:", e);
        cachedPrimaryUid = u.uid;
      }
      window.primaryUid = cachedPrimaryUid;
      return cachedPrimaryUid;
    }

    async function resolveEffectiveAdmin(auth, db) {
      const uid = auth.currentUser?.uid;
      if (!uid) return false;
      try {
        const me = await getDoc(doc(db, "users", uid));
        if (me.exists() && me.data()?.isAdmin === true) return true;

        const a = await getDoc(doc(db, "aliases", uid));
        if (a.exists() && a.data()?.active === true && a.data()?.admin === true) return true;

        const p = a.exists() ? a.data()?.primaryUid : undefined;
        if (p) {
          const primary = await getDoc(doc(db, "users", p));
          if (primary.exists() && primary.data()?.isAdmin === true) return true;
        }
      } catch (e) {
        console.error("resolveEffectiveAdmin error:", e);
      }
      return false;
    }

    function displayUserId(uid, username) {
      const display = document.getElementById('userIdDisplay');
      if (!display) return;
      if (username) {
        display.innerHTML = `
          <div class="bg-yellow-500 bg-opacity-20 px-3 py-2 rounded-lg">
            <span class="text-yellow-300 text-xs">プレイヤーID:</span>
            <span class="text-yellow-100 font-semibold text-sm ml-2">${escapeHtml(username)}</span>
          </div>`;
      } else {
        display.innerHTML = `
          <div class="bg-yellow-500 bg-opacity-20 px-3 py-2 rounded-lg">
            <span class="text-yellow-300 text-xs">プレイヤーID:</span>
            <span class="text-yellow-100 font-mono text-sm ml-2">非表示</span>
            <button onclick="copyUserId('${uid}')" class="ml-2 bg-yellow-600 hover:bg-yellow-700 text-white text-xs px-2 py-1 rounded">コピー</button>
          </div>`;
      }
    }
    window.copyUserId = (uid) => navigator.clipboard.writeText(uid).then(() => showToast('コピーしました','success'));

    async function initFirebase() {
      try {
        app = initializeApp(firebaseConfig);
        auth = getAuth(app);
        db = getFirestore(app);

        if (location.hostname === 'localhost' || location.hostname === '127.0.0.1') {
          window.auth = auth;
          window.db = db;
        }

        await signInAnonymously(auth);

        onAuthStateChanged(auth, async (user) => {
          if (!user) return resetPrimaryUidCache();
          try {
            currentUser = user;

            document.getElementById('loading').classList.add('hidden');
            document.getElementById('app').classList.remove('hidden');

            const [adminFlag, primaryUid] = await Promise.all([
              resolveEffectiveAdmin(auth, db),
              resolvePrimaryUid(auth, db)
            ]);
            isAdmin = adminFlag;
            document.getElementById('adminTab')?.classList.toggle('hidden', !isAdmin);

            await Promise.allSettled([
              loadUserData(primaryUid),
              loadSongs()
            ]);
            renderCurrentPage();
          } catch (err) {
            console.error("login init error:", err);
            showToast("初期化に失敗しました", "error");
          }
        });

        onIdTokenChanged(auth, async (user) => {
          if (!user) return;
          const newIsAdmin = await resolveEffectiveAdmin(auth, db);
          if (newIsAdmin !== isAdmin) {
            isAdmin = newIsAdmin;
            document.getElementById('adminTab')?.classList.toggle('hidden', !isAdmin);
            if (!isAdmin && currentPage === 'admin') switchPage('score');
          }
        });

      } catch (error) {
        console.error("Firebase初期化エラー:", error);
        document.getElementById('loading').innerHTML = `
          <div class="text-white text-center">
            <div class="text-2xl mb-4">Firebase初期化エラー</div>
            <div class="text-sm bg-red-500 bg-opacity-20 p-4 rounded-lg max-w-2xl mx-auto">${escapeHtml(error.message)}</div>
            <div class="text-sm mt-4">firebaseConfigを確認してください</div>
          </div>`;
      }
    }

    async function loadSongs() {
      try {
        const songsCol = collection(db, 'songs');
        const songSnapshot = await getDocs(songsCol);
        songs = songSnapshot.docs.map(d => ({ id: d.id, ...d.data() }));
        songs.sort((a, b) => (a.title || '').localeCompare(b.title || '', 'ja'));
      } catch (e) {
        console.error("楽曲読み込みエラー:", e);
      }
    }

    async function loadUserData(userId) {
      try {
        const userDoc = await getDoc(doc(db, 'users', userId));
        let username = null;
        if (userDoc.exists()) username = userDoc.data().username || null;
        displayUserId(userId, username);

        const scoresCol = collection(db, 'users', userId, 'scores');
        const scoreSnapshot = await getDocs(scoresCol);
        userScores = {};
        scoreSnapshot.docs.forEach(d => { userScores[d.id] = d.data(); });
        console.log(`${scoreSnapshot.docs.length}件のスコアを読み込みました`);

        if (userDoc.exists() && userDoc.data()?.rateMigrated !== true) {
          console.log("初回レート再計算を実行します...");
          await migrateOldRates(userId);
          try {
            await setDoc(doc(db, "users", userId), { rateMigrated: true }, { merge: true });
            console.log("レート再計算が完了しました。");
            showToast('レートの再計算を実行しました', 'success');
          } catch (e) {
            console.error("rateMigratedフラグ更新失敗:", e);
          }
        }
      } catch (e) {
        console.error("ユーザーデータ読み込みエラー:", e);
      }
    }

    async function migrateOldRates(userId) {
      try {
        const scoresCol = collection(db, "users", userId, "scores");
        const scoreSnapshot = await getDocs(scoresCol);
        let updateCount = 0;
        for (const docSnap of scoreSnapshot.docs) {
          const data = docSnap.data();
          const score = data.score;
          const level = data.level;
          if (typeof score !== "number" || typeof level !== "number") continue;
          const recalculated = calculateRate(score, level);
          await setDoc(doc(db, "users", userId, "scores", docSnap.id), { rate: recalculated }, { merge: true });
          updateCount++;
        }
        console.log(`レート再計算完了: ${updateCount}件を更新しました`);
      } catch (e) {
        console.error("レート再計算エラー:", e);
      }
    }

    function calculateRate(score, level) {
      const scoreRate = score >= 999000 ? (level + (2 + (score - 999000) / 10000)) / 34 :
                       score >= 995000 ? (level + (1.5 + (score - 995000) / 8000)) / 34 :
                       score >= 990000 ? (level + (1 + (score - 990000) / 10000)) / 34 :
                       score >= 970000 ? (level + (score - 970000) / 20000) / 34 :
                       score >= 800000 ? (level * (score - 800000) / 170000) / 34 : 0;
      return scoreRate;
    }

    async function saveScore(songId, difficulty, score, level) {
      const rate = calculateRate(parseInt(score,10), parseFloat(level));
      const scoreId = `${songId}_${difficulty}`;
      try {
        const uid = window.primaryUid || await resolvePrimaryUid(auth, db);
        await setDoc(doc(db, 'users', uid, 'scores', scoreId), {
          songId, difficulty,
          score: parseInt(score,10),
          level: parseFloat(level),
          rate: rate,
          timestamp: new Date().toISOString()
        });
        userScores[scoreId] = { songId, difficulty, score: parseInt(score,10), level: parseFloat(level), rate: parseFloat(rate) };
        showToast('スコアを保存しました', 'success');
        window.selectedDifficulty = null;
        window.selectedLevel = null;
        const input = document.getElementById('scoreInput');
        if (input) input.value = '';
        DIFFICULTIES.forEach(d => {
          const btn = document.getElementById(`diff_${d}`);
          if (btn) { btn.classList.remove('bg-opacity-100'); btn.classList.add('bg-opacity-50'); }
        });
        const inputs = document.getElementById('scoreInputs');
        if (inputs) inputs.classList.add('hidden');
        if (currentPage === 'score' && selectedSong && selectedSong.id === songId) {
          const content = document.getElementById('content');
          if (typeof renderScoreEntry === 'function' && content) renderScoreEntry(content);
        }
      } catch (e) {
        console.error('スコア保存エラー:', e);
        showToast('スコアの保存に失敗しました', 'error');
      }
    }

    async function deleteScore(scoreId) {
      if (!confirm('このスコアを削除しますか？')) return;
      try {
        const uid = window.primaryUid || await resolvePrimaryUid(auth, db);
        await deleteDoc(doc(db, 'users', uid, 'scores', scoreId));
        delete userScores[scoreId];
        showToast('スコアを削除しました', 'success');
        renderCurrentPage();
      } catch (e) {
        console.error("スコア削除エラー:", e);
        alert('スコアの削除に失敗しました');
      }
    }

    async function saveSong(songData) {
      const songId = songData.id || `song_${Date.now()}`;
      const imageUrl = document.getElementById('imageUrlInput')?.value || songData.imageUrl || '';
      try {
        await setDoc(doc(db, 'songs', songId), {
          title: songData.title,
          artist: songData.artist,
          difficulties: songData.difficulties,
          imageUrl: imageUrl,
          createdAt: songData.createdAt || new Date().toISOString(),
          updatedAt: new Date().toISOString(),
          tags: Array.isArray(songData.tags) ? songData.tags : []
        });
        await loadSongs();
        editingSong = null;
        showToast('楽曲を保存しました', 'success');
        renderCurrentPage();
      } catch (e) {
        console.error("楽曲保存エラー:", e);
        throw e;
      }
    }

    async function deleteSong(songId) {
      if (!confirm('本当に削除しますか？')) return;
      try {
        await deleteDoc(doc(db, 'songs', songId));
        await loadSongs();
        alert('楽曲を削除しました');
        renderCurrentPage();
      } catch (e) {
        console.error("楽曲削除エラー:", e);
      }
    }

    function switchPage(page) {
      currentPage = page;
      selectedSong = null;
      editingSong = null;
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('bg-white','bg-opacity-20','text-white','text-purple-900');
        btn.classList.add('bg-white','bg-opacity-20','text-white');
      });
      const active = document.getElementById(`${page}Tab`);
      if (active) {
        active.classList.remove('bg-opacity-20','text-white');
        active.classList.add('bg-white','text-purple-900');
      }
      renderCurrentPage();
    }
    window.switchPage = switchPage;

    window.startAddSong = () => { editingSong = {}; renderCurrentPage(); };

    function renderCurrentPage() {
      const content = document.getElementById('content');
      if (currentPage === 'score') {
        if (selectedSong) renderScoreEntry(content);
        else renderSongList(content);
      } else if (currentPage === 'stats') {
        renderStatistics(content);
      } else if (currentPage === 'admin') {
        if (!isAdmin) {
          content.innerHTML = `<div class="bg-white rounded-lg p-6 text-center text-red-600 font-semibold">403 Forbidden — 管理者のみアクセスできます</div>`;
          return;
        }
        renderAdmin(content);
      }
    }
    window.renderCurrentPage = renderCurrentPage;

    function renderSongList(container) {
      const domTerm = document.getElementById('searchInput')?.value || '';
      const rawTerm = (window.songSearchTerm ?? domTerm) || '';
      container.innerHTML = `
        <div class="mb-6">
          <div class="relative">
            <svg aria-hidden="true" class="pointer-events-none absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-500 z-10" viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-4.35-4.35M10.5 18a7.5 7.5 0 110-15 7.5 7.5 0 010 15z"/>
            </svg>
            <input type="text" id="searchInput" placeholder="楽曲名・作曲者名で検索" class="w-full pl-12 pr-4 py-3 rounded-lg bg-gradient-to-br from-white via-white to-slate-200 backdrop-blur-sm text-gray-800 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-purple-500" value="${escapeHtml(rawTerm)}" oninput="handleSongSearch(this.value)" autocomplete="off" spellcheck="false" aria-label="楽曲を検索" />
          </div>
        </div>
        <div id="songGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>`;
      fillSongGrid();
    }

    const _norm = s => (s || '').toString().toLowerCase().normalize('NFKC');

    function _filterSongs(rawTerm) {
      const q = _norm(rawTerm);
      return songs.filter(song => {
        const t = _norm(song.title);
        const a = _norm(song.artist);
        const tagsArr = Array.isArray(song.tags) ? song.tags : (song.tags ? [song.tags] : []);
        const tagHit = tagsArr.some(tag => _norm(tag).includes(q));
        return t.includes(q) || a.includes(q) || tagHit;
      });
    }

    function _renderSongTiles(arr) {
      return arr.map(song => `
        <div onclick="selectSong('${song.id}')" class="bg-gradient-to-br from-white via-white to-slate-200 backdrop-blur-sm rounded-lg overflow-hidden cursor-pointer hover:bg-white transition transform hover:scale-105 shadow-lg">
          ${song.imageUrl ? `
            <div class="w-full h-48 bg-gray-2 00 overflow-hidden">
              <img src="${song.imageUrl}" alt="${escapeHtml(song.title)}" class="w-full h-full object-cover" />
            </div>` : `
            <div class="w-full h-48 bg-gradient-to-br from-purple-400 to-pink-400 flex items-center justify-center">
              <svg class="w-20 h-20 text-white opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3"></path></svg>
            </div>`}
          <div class="p-4">
            <h3 class="font-bold text-lg text-gray-800 mb-1 truncate">${escapeHtml(song.title)}</h3>
            <p class="text-sm text-gray-600 mb-3 truncate">${escapeHtml(song.artist)}</p>
            <div class="flex flex-wrap gap-1">
              ${DIFFICULTIES.map((diff, idx) => song.difficulties?.[diff]
                ? `<span class="${DIFFICULTY_COLORS[idx]} text-white text-xs px-2 py-1 rounded font-semibold">${diff}</span>`
                : '').join('')}
            </div>
          </div>
        </div>`).join('');
    }

    function fillSongGrid() {
      const grid = document.getElementById('songGrid');
      if (!grid) return;
      const domTerm = document.getElementById('searchInput')?.value || '';
      const rawTerm = (window.songSearchTerm ?? domTerm) || '';
      const filtered = _filterSongs(rawTerm);
      grid.innerHTML = _renderSongTiles(filtered);
    }
    window.handleSongSearch = (v) => { window.songSearchTerm = v || ''; if (typeof fillSongGrid === 'function') fillSongGrid(); };
    window.selectSong = (songId) => { selectedSong = songs.find(s => s.id === songId); renderCurrentPage(); };

    function renderScoreEntry(container) {
      const song = selectedSong;
      const registeredChips = DIFFICULTIES.map((diff, idx) => {
        const s = userScores[`${song.id}_${diff}`];
        if (!s) return '';
        return `
          <div class="flex items-center gap-2 px-2 py-1 rounded bg-white bg-opacity-70">
            <span class="${DIFFICULTY_COLORS[idx]} text-white text-[10px] px-2 py-0.5 rounded font-bold">${diff}</span>
            <span class="font-mono text-sm">${Number(s.score).toLocaleString()}</span>
            <span class="text-xs text-gray-500">Rate ${Number(s.rate).toFixed(3)}</span>
          </div>`;
      }).filter(Boolean).join('');

      container.innerHTML = `
        <div class="bg-white bg-opacity-90 backdrop-blur-sm rounded-lg p-6 max-w-2xl mx-auto">
          <button type="button" onclick="goBackFromScore()" class="mb-4 text-purple-700 hover:text-purple-900 font-semibold">← 戻る</button>
          ${song.imageUrl ? `<div class="mb-4 rounded-lg overflow-hidden"><img src="${song.imageUrl}" alt="${escapeHtml(song.title)}" class="w-full h-64 object-cover" /></div>` : ''}
          <h2 class="text-2xl font-bold text-gray-800 mb-2">${escapeHtml(song.title)}</h2>
          <p class="text-gray-600 mb-6">${escapeHtml(song.artist)}</p>
          <div class="space-y-4">
            <div id="registeredScores">
              <div class="text-xs font-semibold text-gray-700">この曲の登録済みスコア</div>
              ${registeredChips ? `<div class="flex flex-wrap gap-2 mt-1">${registeredChips}</div>` : `<div class="text-xs text-gray-500 mt-1">未登録</div>`}
            </div>
            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-2">難易度を選択</label>
              <div class="flex flex-wrap gap-2" id="difficultyButtons">
                ${DIFFICULTIES.map((diff, idx) => song.difficulties?.[diff]
                  ? `<button onclick="selectDifficulty('${diff}', ${song.difficulties[diff]})" class="${DIFFICULTY_COLORS[idx]} bg-opacity-50 hover:bg-opacity-100 text-white px-4 py-2 rounded-lg font-semibold transition" id="diff_${diff}">
                      ${diff} ${Number(song.difficulties[diff]).toFixed(1)}
                    </button>` : '').join('')}
              </div>
            </div>
            <div id="scoreInputs" class="hidden space-y-3">
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">スコア</label>
                <input type="number" id="scoreInput" placeholder="1000000" min="0" max="1000000" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-purple-700" />
                <div id="diffCombined" class="text-sm mt-2"></div>
              </div>
              <button onclick="submitScore()" class="w-full bg-purple-800 hover:bg-purple-900 text-white font-bold py-3 rounded-lg transition">スコアを保存</button>
            </div>
          </div>
        </div>`;
    }

    window.selectDifficulty = (diff, level) => {
      window.selectedDifficulty = diff;
      window.selectedLevel = Number(level);
      const inputs = document.getElementById('scoreInputs');
      if (inputs) inputs.classList.remove('hidden');
      DIFFICULTIES.forEach(d => {
        const btn = document.getElementById(`diff_${d}`);
        if (!btn) return;
        if (d === diff) { btn.classList.remove('bg-opacity-50'); btn.classList.add('bg-opacity-100'); }
        else { btn.classList.remove('bg-opacity-100'); btn.classList.add('bg-opacity-50'); }
      });
      const prev = userScores[`${selectedSong.id}_${diff}`] || null;
      const diffEl = document.getElementById('diffCombined');
      if (prev) {
        updateCombinedLine(Number(prev.score)||0, Number(prev.rate)||0, 0, 0);
      } else {
        diffEl.textContent = '登録済みスコア: 未登録';
      }
      const input = document.getElementById('scoreInput');
      if (input) {
        input.value = '';
        input.oninput  = () => updateDiffUI(prev, window.selectedLevel);
        input.onblur   = () => updateDiffUI(prev, window.selectedLevel);
        input.onchange = () => updateDiffUI(prev, window.selectedLevel);
      }
    };

    function renderStatistics(container) {
      const ratesRaw = Object.values(userScores).map(s => Number(s.rate));
      const rates = ratesRaw.filter(n => !Number.isNaN(n));
      const sorted = [...rates].sort((a, b) => b - a);
      const topRates = sorted.slice(0, 40);
      const sumTop = topRates.reduce((a, b) => a + b, 0);
      const totalRate = topRates.length > 0 ? sumTop.toFixed(4) : '0.0000';
      const formattedRate = totalRate.slice(0, -1) + `<span class="text-sm">${totalRate.slice(-1)}</span>`;
      const scaled = !!window.showScaledRates;
      const displayTopRates = scaled ? topRates.map(r => r * 40) : topRates;
      const sumDisplayTop = displayTopRates.reduce((a, b) => a + b, 0);
      const avgRate = topRates.length > 0 ? (sumDisplayTop / 40).toFixed(3) : '0.000';
      const b40Lower = sorted.length >= 40 ? (scaled ? (sorted[39] * 40).toFixed(3) : sorted[39].toFixed(3)) : '0.000';
      const songMap = Object.fromEntries(songs.map(s => [s.id, s]));
      const scoresWithSongInfo = Object.entries(userScores)
        .map(([id, sc]) => ({ ...sc, song: songMap[sc.songId], scoreId: id }))
        .sort((a, b) => b.rate - a.rate);

      container.innerHTML = `
        <div class="mb-6">
          <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 w-full">
            <div class="bg-slate-50 rounded-lg p-3 shadow-sm text-center">
              <div class="text-xs text-gray-500">Rating</div>
              <div><span id="ratingValue" class="text-xl font-bold text-purple-700">${formattedRate}</span></div>
            </div>
            <div class="bg-slate-50 rounded-lg p-3 shadow-sm text-center">
              <div class="text-xs text-gray-500">B40平均レート</div>
              <div class="text-xl font-bold text-green-500">${avgRate}</div>
            </div>
            <div class="bg-slate-50 rounded-lg p-3 shadow-sm text-center">
              <div class="text-xs text-gray-500">B40下限</div>
              <div class="text-xl font-bold text-sky-500">${b40Lower}</div>
            </div>
            <div class="bg-slate-50 rounded-lg p-3 shadow-sm text-center">
              <div class="text-xs text-gray-500">登録スコア数</div>
              <div class="text-xl font-bold text-purple-700">${Object.keys(userScores).length}</div>
            </div>
          </div>
        </div>
        <button onclick="toggleScaledRates()" id="scaleToggleBtn" class="fixed bottom-4 right-4 sm:bottom-6 sm:right-6 z-50 flex items-center gap-2 px-4 py-2 rounded-full font-semibold shadow-lg transition-all duration-300 ${scaled ? 'bg-gradient-to-r from-green-500 to-emerald-600 text-white hover:from-green-600 hover:to-emerald-700' : 'bg-gradient-to-r from-gray-200 to-gray-300 text-gray-700 hover:from-gray-300 hover:to-gray-400 border border-gray-600'}">
          表示切り替え
        </button>
        <div id="scoreList" class="space-y-2">
          ${scoresWithSongInfo.map((score, idx) => `
            ${scoresWithSongInfo.length > 40 && idx === 40 ? `
              <div class="relative flex items-center justify-center my-6">
                <span class="text-2xl font-bold text-yellow-400 z-10">BEST40</span>
                <div class="absolute left-0 right-2/3 top-1/2 transform -translate-y-1/2 border-t-2 border-yellow-400 z-0"></div>
                <div class="absolute left-2/3 right-0 top-1/2 transform -translate-y-1/2 border-t-2 border-yellow-400 z-0"></div>
              </div>` : ''}
            <div class="flex flex-col sm:flex-row sm:items-center gap-3 p-3 bg-gradient-to-br from-white via-white to-slate-200 rounded-lg shadow-sm">
              ${score.song?.imageUrl ? `
                <img src="${score.song.imageUrl}" alt="${escapeHtml(score.song.title || '')}" class="flex-shrink-0 w-14 h-14 sm:w-16 sm:h-16 object-cover rounded" />` : `
                <div class="flex-shrink-0 w-14 h-14 sm:w-16 sm:h-16 bg-gradient-to-br from-purple-400 to-pink-400 rounded flex items-center justify-center">
                  <svg class="w-8 h-8 text-white opacity-60" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3"></path>
                  </svg>
                </div>`}
              <div class="flex-1 min-w-0">
                <div class="font-semibold text-gray-800 truncate">${escapeHtml(score.song?.title || '(不明な曲)')}</div>
                <div class="text-xs sm:text-sm text-gray-600 truncate">${escapeHtml(score.difficulty)} Lv.${Number(score.level).toFixed(1)}</div>
              </div>
              <div class="flex items-center justify-between sm:justify-end gap-3 sm:ml-4 shrink-0 w-full sm:w-auto">
                <div class="text-right flex-1 sm:flex-none min-w-0">
                  <div class="font-bold text-base sm:text-lg text-purple-700 leading-tight">Rate: ${ (window.showScaledRates ? Number(score.rate * 40).toFixed(3) : Number(score.rate).toFixed(3)) }</div>
                  <div class="text-xs sm:text-sm text-gray-600 leading-tight">${Number(score.score).toLocaleString()}</div>
                </div>
                <button class="px-3 py-2 bg-red-500 hover:bg-red-600 text-white text-xs sm:text-sm rounded-md transition shrink-0" title="削除" onclick="deleteScore('${score.scoreId}')">削除</button>
              </div>
            </div>`).join('')}
        </div>`;
      updateRatingColor(parseFloat(totalRate));
    }

    function renderAdmin(container) {
      if (editingSong) return renderSongEditor(container);
      container.innerHTML = `
        <div class="space-y-6">
          <div class="flex justify-between items-center">
            <h2 class="text-2xl font-bold text-white">楽曲管理</h2>
            <button onclick="startAddSong()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg font-semibold transition">+ 新規追加</button>
          </div>
          <div class="bg-white bg-opacity-90 backdrop-blur-sm rounded-lg p-6">
            <h3 class="text-xl font-bold text-gray-800 mb-4">登録楽曲一覧</h3>
            ${songs.length === 0 ? `
              <div class="text-center py-8 text-gray-500">
                <svg class="w-16 h-16 mx-auto mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3"></path>
                </svg>
                <p class="text-lg">楽曲が登録されていません</p>
                <p class="text-sm mt-2">「新規追加」ボタンから楽曲を追加してください</p>
              </div>` : `
              <div class="space-y-2">
                ${songs.map(song => `
                  <div class="flex items-center gap-4 p-3 bg-gray-50 rounded-lg">
                    ${song.imageUrl ? `
                      <img src="${song.imageUrl}" alt="Preview" class="w-32 h-32 object-cover rounded-lg" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" />
                      <div class="w-32 h-32 bg-gray-200 rounded-lg items-center justify-center flex-shrink-0" style="display:none;">
                        <svg class="w-12 h-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                        </svg>
                      </div>` : `
                      <div class="w-16 h-16 bg-gradient-to-br from-purple-400 to-pink-400 rounded flex items-center justify-center flex-shrink-0">
                        <svg class="w-8 h-8 text-white opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3"></path>
                        </svg>
                      </div>`}
                    <div class="flex-1 min-w-0">
                      <div class="font-semibold text-gray-800 truncate">${escapeHtml(song.title)}</div>
                      <div class="text-sm text-gray-600 truncate">${escapeHtml(song.artist)}</div>
                      <div class="text-xs text-gray-500 truncate">${escapeHtml((song.tags || []).join(', '))}</div>
                    </div>
                    <div class="flex gap-2 flex-shrink-0">
                      <button onclick="editSongById('${song.id}')" class="p-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition">編集</button>
                      <button onclick="deleteSong('${song.id}')" class="p-2 bg-red-500 hover:bg-red-600 text-white rounded-lg transition">削除</button>
                    </div>
                  </div>`).join('')}
              </div>`}
          </div>
        </div>`;
    }

    function renderSongEditor(container) {
      const song = editingSong || {};
      container.innerHTML = `
        <div class="bg-white bg-opacity-90 backdrop-blur-sm rounded-lg p-6 max-w-3xl mx-auto">
          <h3 class="text-xl font-bold text-gray-800 mb-4">${song.id ? '楽曲編集' : '楽曲追加'}</h3>
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-2">ジャケット画像</label>
              <div class="flex items-center gap-4">
                ${song.imageUrl ? `<img src="${song.imageUrl}" alt="Preview" class="w-32 h-32 object-cover rounded-lg" />` : `
                  <div id="previewImage" class="w-32 h-32 bg-gray-200 rounded-lg flex items-center justify-center flex-shrink-0">
                    <svg class="w-12 h-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                    </svg>
                  </div>`}
                <div class="flex-1">
                  <input type="url" id="imageUrlInput" value="${song.imageUrl || ''}" oninput="updateImagePreview(this.value)" placeholder="https://example.com/image.jpg" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-purple-500" />
                  <p class="text-xs text-gray-500 mt-1">ImgBB、Imgur、Googleドライブなどの画像URLを入力</p>
                </div>
              </div>
            </div>
            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-2">楽曲名</label>
              <input type="text" id="songTitle" value="${escapeHtml(song.title || '')}" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-purple-500" />
            </div>
            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-2">アーティスト</label>
              <input type="text" id="songArtist" value="${escapeHtml(song.artist || '')}" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-purple-500" />
            </div>
            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-2">検索用タグ（カンマ区切り）</label>
              <input type="text" id="songTags" value="${escapeHtml((song.tags || []).join(', '))}" placeholder="例) Tag, タグ" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-purple-500" />
              <p class="text-xs text-gray-500 mt-1">検索の別名・読みを登録できます。カンマで区切って複数指定（例: <code>Over limit, オーバーリミット, ≠</code>）</p>
            </div>
            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-2">難易度レベル</label>
              <div class="grid grid-cols-2 md:grid-cols-5 gap-3">
                ${DIFFICULTIES.map((diff, idx) => `
                  <div>
                    <label class="block text-xs font-semibold mb-1 ${DIFFICULTY_COLORS[idx]} text-white px-2 py-1 rounded">${diff}</label>
                    <input type="number" step="0.1" id="diff_${diff}" value="${song.difficulties?.[diff] || ''}" placeholder="未設定" class="w-full px-3 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-purple-500" />
                  </div>`).join('')}
              </div>
            </div>
            <div class="flex gap-3">
              <button id="saveSongButton" onclick="submitSong()" class="flex-1 bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 rounded-lg transition disabled:opacity-50 disabled:cursor-not-allowed">保存</button>
              <button onclick="cancelEditSong()" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 rounded-lg transition">キャンセル</button>
            </div>
          </div>
        </div>`;
    }
    window.updateImagePreview = (url) => {
      const preview = document.getElementById('previewImage');
      if (!preview) return;
      if (!url) {
        if (preview.tagName === 'IMG') {
          const fallback = preview.nextElementSibling;
          if (fallback) fallback.remove();
          preview.outerHTML = `<div id="previewImage" class="w-32 h-32 bg-gray-200 rounded-lg flex items-center justify-center flex-shrink-0">
              <svg class="w-12 h-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
              </svg>
            </div>`;
        }
        return;
      }
      if (preview.tagName === 'DIV') {
        preview.outerHTML = `<img id="previewImage" src="\${url}" alt="Preview" class="w-32 h-32 object-cover rounded-lg"
            onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" />
            <div class="w-32 h-32 bg-gray-200 rounded-lg items-center justify-center flex-shrink-0" style="display:none;">
              <svg class="w-12 h-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
              </svg>
            </div>`;
      } else {
        preview.src = url;
        preview.style.display = 'block';
        const fallback = preview.nextElementSibling;
        if (fallback) fallback.style.display = 'none';
      }
    };

    window.editSongById = (id) => {
      const s = songs.find(x => x.id === id);
      if (!s) return;
      editingSong = s;
      renderCurrentPage();
    };
    window.editSong = (song) => { editingSong = song; renderCurrentPage(); }; // back-compat
    window.cancelEditSong = () => { editingSong = null; renderCurrentPage(); };

    window.updateCombinedLine = (prevScore, prevRate, diffScore, diffRate) => {
      const el = document.getElementById('diffCombined');
      if (!el) return;
      const scoreColor = diffScore > 0 ? 'text-green-500' : diffScore < 0 ? 'text-red-500' : 'text-gray-400';
      const rateColor  = diffRate  > 0 ? 'text-green-500' : diffRate  < 0 ? 'text-red-500' : 'text-gray-400';
      const signScore = diffScore >= 0 ? '+' : '-';
      const signRate  = diffRate  >= 0 ? '+' : '-';
      const absScore  = Math.abs(Math.trunc(diffScore)).toLocaleString();
      const absRate   = Math.abs(diffRate).toFixed(3);
      el.innerHTML = `登録済みスコア: ${Number(prevScore).toLocaleString()} <span class="${scoreColor} font-semibold">${signScore} ${absScore}</span> (Rate ${Number(prevRate).toFixed(3)} <span class="${rateColor} font-semibold">${signRate} ${absRate}</span>)`;
    };
    window.sanitizeAndClampScore = (raw) => {
      const digits = String(raw ?? '').replace(/[^\d]/g, '');
      if (digits === '') return { value: '', number: null };
      let n = parseInt(digits, 10);
      if (Number.isNaN(n)) n = 0;
      if (n > 1000000) n = 1000000;
      if (n < 0) n = 0;
      return { value: String(n), number: n };
    };
    window.updateDiffUI = (prev, level) => {
      const input = document.getElementById('scoreInput');
      const el    = document.getElementById('diffCombined');
      if (!input || !el) return;
      const { value, number } = sanitizeAndClampScore(input.value);
      if (input.value !== value) input.value = value;
      if (!prev) { el.textContent = '登録済みスコア: なし'; return; }
      const prevScore = Number(prev.score) || 0;
      const prevRate  = Number(prev.rate)  || 0;
      if (value === '') { updateCombinedLine(prevScore, prevRate, 0, 0); return; }
      const diffScore = number - prevScore;
      const newRate   = parseFloat(calculateRate(number, level));
      const diffRate  = newRate - prevRate;
      updateCombinedLine(prevScore, prevRate, diffScore, diffRate);
    };
    window.toggleScaledRates = () => { window.showScaledRates = !window.showScaledRates; renderCurrentPage(); };
    window.submitSong = async () => {
      const title = document.getElementById('songTitle').value;
      const artist = document.getElementById('songArtist').value;
      if (!title || !artist) { alert('タイトルとアーティストは必須です'); return; }
      const difficulties = {};
      DIFFICULTIES.forEach(diff => {
        const value = document.getElementById(`diff_${diff}`).value;
        if (value) difficulties[diff] = parseFloat(value);
      });
      const rawTags = (document.getElementById('songTags')?.value || '');
      const tags = rawTags.split(',').map(s => s.trim()).filter(Boolean);
      if (Object.keys(difficulties).length === 0) {
        if (!confirm('難易度が1つも設定されていません。このまま保存しますか？')) return;
      }
      const saveButton = document.getElementById('saveSongButton');
      if (saveButton) { saveButton.disabled = true; saveButton.textContent = '保存中...'; }
      try {
        await saveSong({ ...editingSong, title, artist, difficulties, tags });
      } catch (e) {
        console.error('保存エラー:', e);
        alert('保存に失敗しました: ' + e.message);
        if (saveButton) { saveButton.disabled = false; saveButton.textContent = '保存'; }
      }
    };
    window.submitScore = () => {
      const inputEl = document.getElementById('scoreInput');
      const raw = (inputEl?.value ?? '');
      if (!window.selectedDifficulty) { showToast('難易度を選択してください', 'warn'); return; }
      if (raw.trim() === '') { showToast('スコアが未入力です', 'error'); return; }
      const scoreNum = Math.max(0, Math.min(1000000, parseInt(raw, 10)));
      if (Number.isNaN(scoreNum)) { showToast('スコアが数値ではありません', 'warn'); return; }
      saveScore(selectedSong.id, window.selectedDifficulty, scoreNum, window.selectedLevel);
    };
    window.goBackFromScore = () => { selectedSong = null; window.selectedDifficulty = null; window.selectedLevel = null; renderCurrentPage(); };
    window.deleteSong = deleteSong;
    window.deleteScore = deleteScore;
    window.showScaledRates = false;

    initFirebase();
  </script>
</head>
<body class="min-h-screen bg-gradient-to-br from-gray-950 via-gray-900 to-black">
  <div id="loading" class="min-h-screen flex items-center justify-center">
    <div class="text-white text-2xl">ログイン中...</div>
  </div>

  <div id="app" class="hidden">
    <!-- ヘッダー -->
    <div class="bg-black bg-opacity-50 backdrop-blur-sm border-b border-white border-opacity-20">
      <div class="max-w-7xl mx-auto px-4 py-4">
        <div class="flex items-center justify-between flex-wrap gap-4">
          <div>
            <h1 class="text-2xl md:text-3xl font-bold text-white flex items-center gap-2">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" class="w-8 h-8 text-white" role="img" aria-label="App icon: data cube">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3l8 4.5v9L12 21l-8-4.5v-9L12 3z" />
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7.5l8 4 8-4" />
              </svg>
              CubicDB <small style="font-size: 0.5em;">TAKUMI³ Play³r Database</small>
            </h1>
            <div id="userIdDisplay" class="mt-2"></div>
          </div>
          <div class="flex gap-2 flex-wrap">
            <button id="scoreTab" onclick="switchPage('score')" class="tab-btn px-4 py-2 rounded-lg font-semibold transition bg-white text-purple-900">スコア登録</button>
            <button id="statsTab" onclick="switchPage('stats')" class="tab-btn px-4 py-2 rounded-lg font-semibold transition bg-white bg-opacity-20 text-white">統計</button>
            <button id="adminTab" onclick="switchPage('admin')" class="tab-btn hidden px-4 py-2 rounded-lg font-semibold transition bg-white bg-opacity-20 text-white">管理</button>
          </div>
        </div>
      </div>
    </div>

    <div class="max-w-7xl mx-auto px-4 py-8">
      <div id="content"></div>
    </div>
  </div>
</body>
</html>
