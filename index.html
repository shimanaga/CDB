<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>音楽ゲームスコア管理システム</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, doc, setDoc, getDoc, getDocs, query, where, deleteDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        const DIFFICULTIES = ['BASIC', 'ADVANCED', 'EXPERT', 'MASTER', 'ULTIMA'];
        const DIFFICULTY_COLORS = ['bg-green-500', 'bg-yellow-500', 'bg-red-500', 'bg-purple-500', 'bg-pink-500'];

        let app, auth, db, currentUser, isAdmin = false;
        let songs = [], userScores = {};
        let currentPage = 'score';
        let selectedSong = null;
        let editingSong = null;

        async function initFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                await signInAnonymously(auth);

                // 認証状態の監視
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        currentUser = user;
                        document.getElementById('loading').classList.add('hidden');
                        document.getElementById('app').classList.remove('hidden');
                        await loadUserData(user.uid);
                        await loadSongs();
                        renderCurrentPage();
                    }
                });
            } catch (error) {
                console.error("Firebase初期化エラー:", error);
                alert('Firebase初期化に失敗しました。設定を確認してください。');
            }
        }

        // 楽曲データ読み込み
        async function loadSongs() {
            try {
                const songsCol = collection(db, 'songs');
                const songSnapshot = await getDocs(songsCol);
                songs = songSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                songs.sort((a, b) => a.title.localeCompare(b.title, 'ja'));
            } catch (error) {
                console.error("楽曲読み込みエラー:", error);
            }
        }

        // ユーザーデータ読み込み
        async function loadUserData(userId) {
            try {
                const userDoc = await getDoc(doc(db, 'users', userId));
                if (userDoc.exists() && userDoc.data().isAdmin) {
                    isAdmin = true;
                    document.getElementById('adminTab').classList.remove('hidden');
                }

                const scoresCol = collection(db, 'scores');
                const q = query(scoresCol, where('userId', '==', userId));
                const scoreSnapshot = await getDocs(q);
                userScores = {};
                scoreSnapshot.docs.forEach(doc => {
                    userScores[doc.id] = doc.data();
                });
            } catch (error) {
                console.error("ユーザーデータ読み込みエラー:", error);
            }
        }

        // 単曲レート計算
        function calculateRate(score, level) {
            const baseRate = level;
            const scoreRate = score >= 1007500 ? 2.0 :
                             score >= 1005000 ? 1.5 :
                             score >= 1000000 ? 1.0 :
                             score >= 975000 ? 0.5 :
                             score >= 950000 ? 0 : -0.5;
            return (baseRate + scoreRate).toFixed(2);
        }

        // スコア保存
        async function saveScore(songId, difficulty, score, level) {
            const rate = calculateRate(parseInt(score), parseFloat(level));
            const scoreId = `${currentUser.uid}_${songId}_${difficulty}`;

            try {
                await setDoc(doc(db, 'scores', scoreId), {
                    userId: currentUser.uid,
                    songId,
                    difficulty,
                    score: parseInt(score),
                    level: parseFloat(level),
                    rate: parseFloat(rate),
                    timestamp: new Date().toISOString()
                });

                userScores[scoreId] = { songId, difficulty, score: parseInt(score), level: parseFloat(level), rate: parseFloat(rate) };
                alert('スコアを保存しました！');
                selectedSong = null;
                renderCurrentPage();
            } catch (error) {
                console.error("スコア保存エラー:", error);
                alert('スコアの保存に失敗しました');
            }
        }

        // 楽曲保存
        async function saveSong(songData) {
            try {
                const songId = songData.id || `song_${Date.now()}`;
                await setDoc(doc(db, 'songs', songId), {
                    title: songData.title,
                    artist: songData.artist,
                    difficulties: songData.difficulties
                });

                await loadSongs();
                editingSong = null;
                alert('楽曲を保存しました！');
                renderCurrentPage();
            } catch (error) {
                console.error("楽曲保存エラー:", error);
                alert('楽曲の保存に失敗しました');
            }
        }

        // 楽曲削除
        async function deleteSong(songId) {
            if (!confirm('本当に削除しますか？')) return;

            try {
                await deleteDoc(doc(db, 'songs', songId));
                await loadSongs();
                alert('楽曲を削除しました');
                renderCurrentPage();
            } catch (error) {
                console.error("楽曲削除エラー:", error);
            }
        }

        // ページ切り替え
        function switchPage(page) {
            currentPage = page;
            selectedSong = null;
            editingSong = null;
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('bg-white', 'text-purple-900');
                btn.classList.add('bg-white', 'bg-opacity-20', 'text-white');
            });
            document.getElementById(`${page}Tab`).classList.remove('bg-opacity-20');
            document.getElementById(`${page}Tab`).classList.add('bg-white', 'text-purple-900');
            renderCurrentPage();
        }

        // ページレンダリング
        function renderCurrentPage() {
            const content = document.getElementById('content');
            
            if (currentPage === 'score') {
                if (selectedSong) {
                    renderScoreEntry(content);
                } else {
                    renderSongList(content);
                }
            } else if (currentPage === 'stats') {
                renderStatistics(content);
            } else if (currentPage === 'admin') {
                renderAdmin(content);
            }
        }

        // 楽曲リスト表示
        function renderSongList(container) {
            const searchTerm = document.getElementById('searchInput')?.value.toLowerCase() || '';
            const filteredSongs = songs.filter(song =>
                song.title.toLowerCase().includes(searchTerm) ||
                song.artist.toLowerCase().includes(searchTerm)
            );

            container.innerHTML = `
                <div class="mb-6">
                    <div class="relative">
                        <svg class="absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400 w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                        <input
                            type="text"
                            id="searchInput"
                            placeholder="楽曲名やアーティスト名で検索..."
                            class="w-full pl-12 pr-4 py-3 rounded-lg bg-white bg-opacity-90 backdrop-blur-sm text-gray-800 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-purple-500"
                            oninput="renderCurrentPage()"
                        />
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    ${filteredSongs.map(song => `
                        <div onclick="selectSong('${song.id}')" class="bg-white bg-opacity-90 backdrop-blur-sm rounded-lg p-4 cursor-pointer hover:bg-opacity-100 transition transform hover:scale-105">
                            <h3 class="font-bold text-lg text-gray-800 mb-1">${escapeHtml(song.title)}</h3>
                            <p class="text-sm text-gray-600 mb-3">${escapeHtml(song.artist)}</p>
                            <div class="flex flex-wrap gap-1">
                                ${DIFFICULTIES.map((diff, idx) => 
                                    song.difficulties?.[diff] ? 
                                    `<span class="${DIFFICULTY_COLORS[idx]} text-white text-xs px-2 py-1 rounded">${diff}</span>` 
                                    : ''
                                ).join('')}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // スコア入力画面
        function renderScoreEntry(container) {
            const song = selectedSong;
            container.innerHTML = `
                <div class="bg-white bg-opacity-90 backdrop-blur-sm rounded-lg p-6 max-w-2xl mx-auto">
                    <button onclick="selectedSong = null; renderCurrentPage();" class="mb-4 text-purple-700 hover:text-purple-900 font-semibold">
                        ← 戻る
                    </button>
                    
                    <h2 class="text-2xl font-bold text-gray-800 mb-2">${escapeHtml(song.title)}</h2>
                    <p class="text-gray-600 mb-6">${escapeHtml(song.artist)}</p>

                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">難易度を選択</label>
                            <div class="flex flex-wrap gap-2" id="difficultyButtons">
                                ${DIFFICULTIES.map((diff, idx) => 
                                    song.difficulties?.[diff] ? 
                                    `<button onclick="selectDifficulty('${diff}', ${song.difficulties[diff]})" class="${DIFFICULTY_COLORS[idx]} bg-opacity-50 hover:bg-opacity-100 text-white px-4 py-2 rounded-lg font-semibold transition" id="diff_${diff}">
                                        ${diff} ${song.difficulties[diff]}
                                    </button>` 
                                    : ''
                                ).join('')}
                            </div>
                        </div>

                        <div id="scoreInputs" class="hidden space-y-4">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">スコア</label>
                                <input type="number" id="scoreInput" placeholder="1000000" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-purple-500" />
                            </div>

                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">譜面レベル</label>
                                <input type="number" step="0.1" id="levelInput" placeholder="12.5" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-purple-500" />
                            </div>

                            <button onclick="submitScore()" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 rounded-lg transition">
                                スコアを保存
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // 統計画面
        function renderStatistics(container) {
            const rates = Object.values(userScores).map(s => parseFloat(s.rate));
            const avgRate = rates.length > 0 ? (rates.reduce((a, b) => a + b, 0) / rates.length).toFixed(2) : '0.00';
            const topRates = [...rates].sort((a, b) => b - a).slice(0, 30);
            const overallRate = topRates.length > 0 ? (topRates.reduce((a, b) => a + b, 0) / topRates.length).toFixed(2) : '0.00';
            const maxRate = rates.length > 0 ? Math.max(...rates).toFixed(2) : '0.00';

            const songMap = Object.fromEntries(songs.map(s => [s.id, s]));
            const scoresWithSongInfo = Object.entries(userScores)
                .map(([id, score]) => ({ ...score, song: songMap[score.songId] }))
                .filter(s => s.song)
                .sort((a, b) => parseFloat(b.rate) - parseFloat(a.rate));

            container.innerHTML = `
                <div class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div class="bg-white bg-opacity-90 backdrop-blur-sm rounded-lg p-6">
                            <div class="text-sm text-gray-600 mb-1">登録スコア数</div>
                            <div class="text-3xl font-bold text-purple-700">${Object.keys(userScores).length}</div>
                        </div>
                        <div class="bg-white bg-opacity-90 backdrop-blur-sm rounded-lg p-6">
                            <div class="text-sm text-gray-600 mb-1">平均レート</div>
                            <div class="text-3xl font-bold text-blue-700">${avgRate}</div>
                        </div>
                        <div class="bg-white bg-opacity-90 backdrop-blur-sm rounded-lg p-6">
                            <div class="text-sm text-gray-600 mb-1">総合レート (TOP30平均)</div>
                            <div class="text-3xl font-bold text-green-700">${overallRate}</div>
                        </div>
                        <div class="bg-white bg-opacity-90 backdrop-blur-sm rounded-lg p-6">
                            <div class="text-sm text-gray-600 mb-1">最高レート</div>
                            <div class="text-3xl font-bold text-pink-700">${maxRate}</div>
                        </div>
                    </div>

                    <div class="bg-white bg-opacity-90 backdrop-blur-sm rounded-lg p-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">スコア一覧</h3>
                        <div class="space-y-2 max-h-96 overflow-y-auto">
                            ${scoresWithSongInfo.map(score => `
                                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                    <div class="flex-1">
                                        <div class="font-semibold text-gray-800">${escapeHtml(score.song.title)}</div>
                                        <div class="text-sm text-gray-600">${score.difficulty} Lv.${score.level}</div>
                                    </div>
                                    <div class="text-right">
                                        <div class="font-bold text-lg text-purple-700">Rate: ${score.rate}</div>
                                        <div class="text-sm text-gray-600">${score.score.toLocaleString()}</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        // 管理画面
        function renderAdmin(container) {
            if (editingSong) {
                renderSongEditor(container);
            } else {
                container.innerHTML = `
                    <div class="space-y-6">
                        <div class="flex justify-between items-center">
                            <h2 class="text-2xl font-bold text-white">楽曲管理</h2>
                            <button onclick="editingSong = {}; renderCurrentPage();" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg font-semibold">
                                + 新規追加
                            </button>
                        </div>

                        <div class="bg-white bg-opacity-90 backdrop-blur-sm rounded-lg p-6">
                            <h3 class="text-xl font-bold text-gray-800 mb-4">登録楽曲一覧</h3>
                            <div class="space-y-2 max-h-96 overflow-y-auto">
                                ${songs.map(song => `
                                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                        <div class="flex-1">
                                            <div class="font-semibold text-gray-800">${escapeHtml(song.title)}</div>
                                            <div class="text-sm text-gray-600">${escapeHtml(song.artist)}</div>
                                        </div>
                                        <div class="flex gap-2">
                                            <button onclick='editSong(${JSON.stringify(song).replace(/'/g, "&apos;")})' class="p-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg">
                                                編集
                                            </button>
                                            <button onclick="deleteSong('${song.id}')" class="p-2 bg-red-500 hover:bg-red-600 text-white rounded-lg">
                                                削除
                                            </button>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        // 楽曲編集画面
        function renderSongEditor(container) {
            const song = editingSong;
            container.innerHTML = `
                <div class="bg-white bg-opacity-90 backdrop-blur-sm rounded-lg p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">${song.id ? '楽曲編集' : '楽曲追加'}</h3>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">楽曲名</label>
                            <input type="text" id="songTitle" value="${escapeHtml(song.title || '')}" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-purple-500" />
                        </div>

                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">アーティスト</label>
                            <input type="text" id="songArtist" value="${escapeHtml(song.artist || '')}" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-purple-500" />
                        </div>

                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">難易度レベル</label>
                            <div class="grid grid-cols-1 md:grid-cols-5 gap-3">
                                ${DIFFICULTIES.map((diff, idx) => `
                                    <div>
                                        <label class="block text-xs font-semibold mb-1 ${DIFFICULTY_COLORS[idx]} text-white px-2 py-1 rounded">
                                            ${diff}
                                        </label>
                                        <input type="number" step="0.1" id="diff_${diff}" value="${song.difficulties?.[diff] || ''}" placeholder="未設定" class="w-full px-3 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-purple-500" />
                                    </div>
                                `).join('')}
                            </div>
                        </div>

                        <div class="flex gap-3">
                            <button onclick="submitSong()" class="flex-1 bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 rounded-lg">
                                保存
                            </button>
                            <button onclick="editingSong = null; renderCurrentPage();" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 rounded-lg">
                                キャンセル
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // グローバル関数
        window.selectSong = (songId) => {
            selectedSong = songs.find(s => s.id === songId);
            renderCurrentPage();
        };

        window.selectDifficulty = (diff, level) => {
            window.selectedDifficulty = diff;
            document.getElementById('levelInput').value = level;
            document.getElementById('scoreInputs').classList.remove('hidden');
            
            DIFFICULTIES.forEach(d => {
                const btn = document.getElementById(`diff_${d}`);
                if (btn) {
                    if (d === diff) {
                        btn.classList.remove('bg-opacity-50');
                        btn.classList.add('bg-opacity-100');
                    } else {
                        btn.classList.remove('bg-opacity-100');
                        btn.classList.add('bg-opacity-50');
                    }
                }
            });
        };

        window.submitScore = () => {
            const score = document.getElementById('scoreInput').value;
            const level = document.getElementById('levelInput').value;
            if (!window.selectedDifficulty || !score || !level) {
                alert('すべての項目を入力してください');
                return;
            }
            saveScore(selectedSong.id, window.selectedDifficulty, score, level);
        };

        window.editSong = (song) => {
            editingSong = song;
            renderCurrentPage();
        };

        window.submitSong = () => {
            const title = document.getElementById('songTitle').value;
            const artist = document.getElementById('songArtist').value;
            
            if (!title || !artist) {
                alert('タイトルとアーティストは必須です');
                return;
            }

            const difficulties = {};
            DIFFICULTIES.forEach(diff => {
                const value = document.getElementById(`diff_${diff}`).value;
                if (value) difficulties[diff] = parseFloat(value);
            });

            saveSong({
                ...editingSong,
                title,
                artist,
                difficulties
            });
        };

        window.deleteSong = deleteSong;
        window.renderCurrentPage = renderCurrentPage;

        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text?.toString().replace(/[&<>"']/g, m => map[m]) || '';
        }

        // 初期化
        initFirebase();

        // タブ切り替え関数をグローバルに公開
        window.switchPage = switchPage;
    </script>
</head>
<body class="min-h-screen bg-gradient-to-br from-purple-900 via-blue-900 to-indigo-900">
    <!-- ローディング画面 -->
    <div id="loading" class="min-h-screen flex items-center justify-center">
        <div class="text-white text-2xl">ログイン中...</div>
    </div>

    <!-- メインアプリ -->
    <div id="app" class="hidden">
        <!-- ヘッダー -->
        <div class="bg-black bg-opacity-50 backdrop-blur-sm border-b border-white border-opacity-20">
            <div class="max-w-7xl mx-auto px-4 py-4">
                <div class="flex items-center justify-between flex-wrap gap-4">
                    <h1 class="text-2xl md:text-3xl font-bold text-white flex items-center gap-2">
                        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3"></path>
                        </svg>
                        Score Manager
                    </h1>
                    <div class="flex gap-2 flex-wrap">
                        <button id="scoreTab" onclick="switchPage('score')" class="tab-btn px-4 py-2 rounded-lg font-semibold transition bg-white text-purple-900">
                            スコア登録
                        </button>
                        <button id="statsTab" onclick="switchPage('stats')" class="tab-btn px-4 py-2 rounded-lg font-semibold transition bg-white bg-opacity-20 text-white hover:bg-opacity-30">
                            統計
                        </button>
                        <button id="adminTab" onclick="switchPage('admin')" class="tab-btn hidden px-4 py-2 rounded-lg font-semibold transition bg-white bg-opacity-20 text-white hover:bg-opacity-30">
                            管理
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- コンテンツエリア -->
        <div class="max-w-7xl mx-auto px-4 py-8">
            <div id="content"></div>
        </div>
    </div>
</body>
</html>
