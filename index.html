<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Èü≥Ê•Ω„Ç≤„Éº„É†„Çπ„Ç≥„Ç¢ÁÆ°ÁêÜ„Ç∑„Çπ„ÉÜ„É†</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, doc, setDoc, getDoc, getDocs, query, where, deleteDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js';

        // FirebaseË®≠ÂÆöÔºà„ÅÇ„Å™„Åü„ÅÆË®≠ÂÆöÂÄ§„Å´ÁΩÆ„ÅçÊèõ„Åà„Å¶„Åè„Å†„Åï„ÅÑÔºâ
        const firebaseConfig = {
            apiKey: "AIzaSyBrlOj1D_Tkk16l9_T_gHcGgGvgjXrkg2k",
            authDomain: "tcdb-de19d.firebaseapp.com",
            projectId: "tcdb-de19d",
            storageBucket: "tcdb-de19d.firebasestorage.app",
            messagingSenderId: "914426625733",
            appId: "1:914426625733:web:1d167f8648e40268a2baac",
            measurementId: "G-W8N9ZDFT6Y"
        };

        const DIFFICULTIES = ['NORMAL', 'HARD', 'MASTER', 'INSANITY', 'RAVAGE'];
        const DIFFICULTY_COLORS = ['bg-sky-400', 'bg-amber-500', 'bg-purple-600', 'bg-slate-400', 'bg-red-600'];

        let app, auth, db, storage, currentUser, isAdmin = false;
        let songs = [], userScores = {};
        let currentPage = 'score';
        let selectedSong = null;
        let editingSong = null;
        let uploadedImageFile = null;

        // FirebaseÂàùÊúüÂåñ
        async function initFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                storage = getStorage(app);

                // „Ç∞„É≠„Éº„Éê„É´„Å´ÂÖ¨ÈñãÔºà„Éá„Éê„ÉÉ„Ç∞Áî®Ôºâ
                window.auth = auth;
                window.db = db;
                window.storage = storage;

                // ÂåøÂêçË™çË®º
                await signInAnonymously(auth);

                // Ë™çË®ºÁä∂ÊÖã„ÅÆÁõ£Ë¶ñ
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        currentUser = user;
                        window.currentUser = user; // „Ç∞„É≠„Éº„Éê„É´„Å´ÂÖ¨Èñã
                        
                        // „É¶„Éº„Ç∂„ÉºID„ÇíË°®Á§∫
                        displayUserId(user.uid);
                        
                        document.getElementById('loading').classList.add('hidden');
                        document.getElementById('app').classList.remove('hidden');
                        await loadUserData(user.uid);
                        await loadSongs();
                        renderCurrentPage();
                    }
                });
            } catch (error) {
                console.error("FirebaseÂàùÊúüÂåñ„Ç®„É©„Éº:", error);
                document.getElementById('loading').innerHTML = `
                    <div class="text-white text-center">
                        <div class="text-2xl mb-4">FirebaseÂàùÊúüÂåñ„Ç®„É©„Éº</div>
                        <div class="text-sm bg-red-500 bg-opacity-20 p-4 rounded-lg max-w-2xl mx-auto">
                            ${error.message}
                        </div>
                        <div class="text-sm mt-4">firebaseConfig„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ</div>
                    </div>
                `;
            }
        }

        // „É¶„Éº„Ç∂„ÉºIDË°®Á§∫
        function displayUserId(uid) {
            const display = document.getElementById('userIdDisplay');
            if (display) {
                display.innerHTML = `
                    <div class="bg-yellow-500 bg-opacity-20 px-3 py-2 rounded-lg">
                        <span class="text-yellow-300 text-xs">„ÅÇ„Å™„Åü„ÅÆ„É¶„Éº„Ç∂„ÉºID:</span>
                        <span class="text-yellow-100 font-mono text-sm ml-2">${uid}</span>
                        <button onclick="copyUserId('${uid}')" class="ml-2 bg-yellow-600 hover:bg-yellow-700 text-white text-xs px-2 py-1 rounded">
                            üìã „Ç≥„Éî„Éº
                        </button>
                    </div>
                `;
            }
        }

        // „É¶„Éº„Ç∂„ÉºID„Ç≥„Éî„Éº
        window.copyUserId = (uid) => {
            navigator.clipboard.writeText(uid).then(() => {
                alert('„É¶„Éº„Ç∂„ÉºID„Çí„Ç≥„Éî„Éº„Åó„Åæ„Åó„ÅüÔºÅ\n\nFirestore„ÅÆ users „Ç≥„É¨„ÇØ„Ç∑„Éß„É≥„Åß\n„Åì„ÅÆID„Çí„Éâ„Ç≠„É•„É°„É≥„ÉàID„Å®„Åó„Å¶‰ΩøÁî®„Åó„ÄÅ\nisAdmin: true „ÇíË®≠ÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
            });
        };

        // Ê•ΩÊõ≤„Éá„Éº„ÇøË™≠„ÅøËæº„Åø
        async function loadSongs() {
            try {
                const songsCol = collection(db, 'songs');
                const songSnapshot = await getDocs(songsCol);
                songs = songSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                songs.sort((a, b) => a.title.localeCompare(b.title, 'ja'));
                window.songs = songs; // „Ç∞„É≠„Éº„Éê„É´„Å´ÂÖ¨Èñã
            } catch (error) {
                console.error("Ê•ΩÊõ≤Ë™≠„ÅøËæº„Åø„Ç®„É©„Éº:", error);
            }
        }

        // „É¶„Éº„Ç∂„Éº„Éá„Éº„ÇøË™≠„ÅøËæº„Åø
        async function loadUserData(userId) {
            try {
                const userDoc = await getDoc(doc(db, 'users', userId));
                if (userDoc.exists() && userDoc.data().isAdmin) {
                    isAdmin = true;
                    window.isAdmin = true; // „Ç∞„É≠„Éº„Éê„É´„Å´ÂÖ¨Èñã
                    document.getElementById('adminTab').classList.remove('hidden');
                }

                const scoresCol = collection(db, 'scores');
                const q = query(scoresCol, where('userId', '==', userId));
                const scoreSnapshot = await getDocs(q);
                userScores = {};
                scoreSnapshot.docs.forEach(doc => {
                    userScores[doc.id] = doc.data();
                });
                window.userScores = userScores; // „Ç∞„É≠„Éº„Éê„É´„Å´ÂÖ¨Èñã
            } catch (error) {
                console.error("„É¶„Éº„Ç∂„Éº„Éá„Éº„ÇøË™≠„ÅøËæº„Åø„Ç®„É©„Éº:", error);
            }
        }

        // ÁîªÂÉè„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ
        async function uploadImage(file, songId) {
            try {
                const timestamp = Date.now();
                const fileName = `songs/${songId}_${timestamp}.${file.name.split('.').pop()}`;
                const storageRef = ref(storage, fileName);
                
                await uploadBytes(storageRef, file);
                const downloadURL = await getDownloadURL(storageRef);
                
                return { url: downloadURL, path: fileName };
            } catch (error) {
                console.error("ÁîªÂÉè„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Ç®„É©„Éº:", error);
                throw error;
            }
        }

        // Âè§„ÅÑÁîªÂÉèÂâäÈô§
        async function deleteOldImage(imagePath) {
            if (!imagePath) return;
            try {
                const imageRef = ref(storage, imagePath);
                await deleteObject(imageRef);
            } catch (error) {
                console.error("ÁîªÂÉèÂâäÈô§„Ç®„É©„Éº:", error);
            }
        }

        // ÂçòÊõ≤„É¨„Éº„ÉàË®àÁÆó
        function calculateRate(score, level) {
            const baseRate = level;
            const scoreRate = score >= 999000 ? (level + (2 + (score - 999000) / 10000)) / 34 :
                             score >= 995000 ? (level + (1.5 + (score - 995000) / 8000)) / 34 :
                             score >= 990000 ? (level + (1 + (score - 990000) / 10000)) / 34 :
                             score >= 970000 ? (level + (score - 970000) / 20000) / 34 :
                             score >= 800000 ? (level * (score - 800000) / 170000) / 34 : 0;
            return (baseRate + scoreRate).toFixed(3);
        }

        // „Çπ„Ç≥„Ç¢‰øùÂ≠ò
        async function saveScore(songId, difficulty, score, level) {
            const rate = calculateRate(parseInt(score), parseFloat(level));
            const scoreId = `${currentUser.uid}_${songId}_${difficulty}`;

            try {
                await setDoc(doc(db, 'scores', scoreId), {
                    userId: currentUser.uid,
                    songId,
                    difficulty,
                    score: parseInt(score),
                    level: parseFloat(level),
                    rate: parseFloat(rate),
                    timestamp: new Date().toISOString()
                });

                userScores[scoreId] = { songId, difficulty, score: parseInt(score), level: parseFloat(level), rate: parseFloat(rate) };
                alert('„Çπ„Ç≥„Ç¢„Çí‰øùÂ≠ò„Åó„Åæ„Åó„ÅüÔºÅ');
                selectedSong = null;
                renderCurrentPage();
            } catch (error) {
                console.error("„Çπ„Ç≥„Ç¢‰øùÂ≠ò„Ç®„É©„Éº:", error);
                alert('„Çπ„Ç≥„Ç¢„ÅÆ‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
            }
        }

        // Ê•ΩÊõ≤‰øùÂ≠ò
        async function saveSong(songData) {
            try {
                const songId = songData.id || `song_${Date.now()}`;
                let imageUrl = songData.imageUrl || '';
                let imagePath = songData.imagePath || '';

                // Êñ∞„Åó„ÅÑÁîªÂÉè„Åå„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Åï„Çå„ÅüÂ†¥Âêà
                if (uploadedImageFile) {
                    // Âè§„ÅÑÁîªÂÉè„ÇíÂâäÈô§
                    if (songData.imagePath) {
                        await deleteOldImage(songData.imagePath);
                    }
                    
                    // Êñ∞„Åó„ÅÑÁîªÂÉè„Çí„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ
                    const imageData = await uploadImage(uploadedImageFile, songId);
                    imageUrl = imageData.url;
                    imagePath = imageData.path;
                }

                await setDoc(doc(db, 'songs', songId), {
                    title: songData.title,
                    artist: songData.artist,
                    difficulties: songData.difficulties,
                    imageUrl: imageUrl,
                    imagePath: imagePath
                });

                await loadSongs();
                editingSong = null;
                uploadedImageFile = null;
                alert('Ê•ΩÊõ≤„Çí‰øùÂ≠ò„Åó„Åæ„Åó„ÅüÔºÅ');
                renderCurrentPage();
            } catch (error) {
                console.error("Ê•ΩÊõ≤‰øùÂ≠ò„Ç®„É©„Éº:", error);
                alert('Ê•ΩÊõ≤„ÅÆ‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
            }
        }

        // Ê•ΩÊõ≤ÂâäÈô§
        async function deleteSong(songId) {
            if (!confirm('Êú¨ÂΩì„Å´ÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) return;

            try {
                const song = songs.find(s => s.id === songId);
                
                // ÁîªÂÉè„ÇÇÂâäÈô§
                if (song && song.imagePath) {
                    await deleteOldImage(song.imagePath);
                }
                
                await deleteDoc(doc(db, 'songs', songId));
                await loadSongs();
                alert('Ê•ΩÊõ≤„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü');
                renderCurrentPage();
            } catch (error) {
                console.error("Ê•ΩÊõ≤ÂâäÈô§„Ç®„É©„Éº:", error);
            }
        }

        // „Éö„Éº„Ç∏Âàá„ÇäÊõø„Åà
        function switchPage(page) {
            currentPage = page;
            selectedSong = null;
            editingSong = null;
            uploadedImageFile = null;
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('bg-white', 'text-purple-900');
                btn.classList.add('bg-white', 'bg-opacity-20', 'text-white');
            });
            document.getElementById(`${page}Tab`).classList.remove('bg-opacity-20');
            document.getElementById(`${page}Tab`).classList.add('bg-white', 'text-purple-900');
            renderCurrentPage();
        }

        // Ê•ΩÊõ≤ËøΩÂä†ÈñãÂßã
        window.startAddSong = () => {
            editingSong = {};
            uploadedImageFile = null;
            renderCurrentPage();
        };

        // „Éö„Éº„Ç∏„É¨„É≥„ÉÄ„É™„É≥„Ç∞
        function renderCurrentPage() {
            const content = document.getElementById('content');
            
            if (currentPage === 'score') {
                if (selectedSong) {
                    renderScoreEntry(content);
                } else {
                    renderSongList(content);
                }
            } else if (currentPage === 'stats') {
                renderStatistics(content);
            } else if (currentPage === 'admin') {
                renderAdmin(content);
            }
        }

        // Ê•ΩÊõ≤„É™„Çπ„ÉàË°®Á§∫
        function renderSongList(container) {
            const searchTerm = document.getElementById('searchInput')?.value.toLowerCase() || '';
            const filteredSongs = songs.filter(song =>
                song.title.toLowerCase().includes(searchTerm) ||
                song.artist.toLowerCase().includes(searchTerm)
            );

            container.innerHTML = `
                <div class="mb-6">
                    <div class="relative">
                        <svg class="absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400 w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                        <input
                            type="text"
                            id="searchInput"
                            placeholder="Ê•ΩÊõ≤Âêç„ÇÑ„Ç¢„Éº„ÉÜ„Ç£„Çπ„ÉàÂêç„ÅßÊ§úÁ¥¢..."
                            class="w-full pl-12 pr-4 py-3 rounded-lg bg-white bg-opacity-90 backdrop-blur-sm text-gray-800 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-purple-500"
                            oninput="renderCurrentPage()"
                        />
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    ${filteredSongs.map(song => `
                        <div onclick="selectSong('${song.id}')" class="bg-white bg-opacity-90 backdrop-blur-sm rounded-lg overflow-hidden cursor-pointer hover:bg-opacity-100 transition transform hover:scale-105 shadow-lg">
                            ${song.imageUrl ? `
                                <div class="w-full h-48 bg-gray-200 overflow-hidden">
                                    <img src="${song.imageUrl}" alt="${escapeHtml(song.title)}" class="w-full h-full object-cover" />
                                </div>
                            ` : `
                                <div class="w-full h-48 bg-gradient-to-br from-purple-400 to-pink-400 flex items-center justify-center">
                                    <svg class="w-20 h-20 text-white opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3"></path>
                                    </svg>
                                </div>
                            `}
                            <div class="p-4">
                                <h3 class="font-bold text-lg text-gray-800 mb-1 truncate">${escapeHtml(song.title)}</h3>
                                <p class="text-sm text-gray-600 mb-3 truncate">${escapeHtml(song.artist)}</p>
                                <div class="flex flex-wrap gap-1">
                                    ${DIFFICULTIES.map((diff, idx) => 
                                        song.difficulties?.[diff] ? 
                                        `<span class="${DIFFICULTY_COLORS[idx]} text-white text-xs px-2 py-1 rounded font-semibold">${diff}</span>` 
                                        : ''
                                    ).join('')}
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // „Çπ„Ç≥„Ç¢ÂÖ•ÂäõÁîªÈù¢
        function renderScoreEntry(container) {
            const song = selectedSong;
            container.innerHTML = `
                <div class="bg-white bg-opacity-90 backdrop-blur-sm rounded-lg p-6 max-w-2xl mx-auto">
                    <button onclick="selectedSong = null; renderCurrentPage();" class="mb-4 text-purple-700 hover:text-purple-900 font-semibold">
                        ‚Üê Êàª„Çã
                    </button>
                    
                    ${song.imageUrl ? `
                        <div class="mb-4 rounded-lg overflow-hidden">
                            <img src="${song.imageUrl}" alt="${escapeHtml(song.title)}" class="w-full h-64 object-cover" />
                        </div>
                    ` : ''}
                    
                    <h2 class="text-2xl font-bold text-gray-800 mb-2">${escapeHtml(song.title)}</h2>
                    <p class="text-gray-600 mb-6">${escapeHtml(song.artist)}</p>

                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Èõ£ÊòìÂ∫¶„ÇíÈÅ∏Êäû</label>
                            <div class="flex flex-wrap gap-2" id="difficultyButtons">
                                ${DIFFICULTIES.map((diff, idx) => 
                                    song.difficulties?.[diff] ? 
                                    `<button onclick="selectDifficulty('${diff}', ${song.difficulties[diff]})" class="${DIFFICULTY_COLORS[idx]} bg-opacity-50 hover:bg-opacity-100 text-white px-4 py-2 rounded-lg font-semibold transition" id="diff_${diff}">
                                        ${diff} ${Number(song.difficulties[diff]).toFixed(1)}
                                    </button>` 
                                    : ''
                                ).join('')}
                            </div>
                        </div>

                        <div id="scoreInputs" class="hidden space-y-4">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">„Çπ„Ç≥„Ç¢</label>
                                <input type="number" id="scoreInput" placeholder="1000000" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-purple-500" />
                            </div>

                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Ë≠úÈù¢„É¨„Éô„É´</label>
                                <input type="number" step="0.1" id="levelInput" placeholder="12.5" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-purple-500" />
                            </div>

                            <button onclick="submitScore()" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 rounded-lg transition">
                                „Çπ„Ç≥„Ç¢„Çí‰øùÂ≠ò
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // Áµ±Ë®àÁîªÈù¢
        function renderStatistics(container) {
            const rates = Object.values(userScores).map(s => parseFloat(s.rate));
            const topRates = [...rates].sort((a, b) => b - a).slice(0, 40);
            const avgRate = topRates.length > 0 ? (topRates.reduce((a, b) => a + b, 0) / topRates.length).toFixed(2) : '0.000';

            const songMap = Object.fromEntries(songs.map(s => [s.id, s]));
            const scoresWithSongInfo = Object.entries(userScores)
                .map(([id, score]) => ({ ...score, song: songMap[score.songId] }))
                .filter(s => s.song)
                .sort((a, b) => parseFloat(b.rate) - parseFloat(a.rate));

            container.innerHTML = `
                <div class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div class="bg-white bg-opacity-90 backdrop-blur-sm rounded-lg p-6">
                            <div class="text-sm text-gray-600 mb-1">Rating</div>
                            <div class="text-3xl font-bold text-red-700">${totalRate}</div>
                        </div>
                        <div class="bg-white bg-opacity-90 backdrop-blur-sm rounded-lg p-6">
                            <div class="text-sm text-gray-600 mb-1">Âπ≥Âùá„É¨„Éº„Éà</div>
                            <div class="text-3xl font-bold text-blue-700">${avgRate}</div>
                        </div>
                        <div class="bg-white bg-opacity-90 backdrop-blur-sm rounded-lg p-6">
                            <div class="text-sm text-gray-600 mb-1">ÁôªÈå≤„Çπ„Ç≥„Ç¢Êï∞</div>
                            <div class="text-3xl font-bold text-purple-700">${Object.keys(userScores).length}</div>
                        </div>
                    </div>

                    <div class="bg-white bg-opacity-90 backdrop-blur-sm rounded-lg p-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">„Çπ„Ç≥„Ç¢‰∏ÄË¶ß</h3>
                        <div class="space-y-2 max-h-96 overflow-y-auto">
                            ${scoresWithSongInfo.map(score => `
                                <div class="flex items-center gap-4 p-3 bg-gray-50 rounded-lg">
                                    ${score.song.imageUrl ? `
                                        <img src="${score.song.imageUrl}" alt="${escapeHtml(score.song.title)}" class="w-16 h-16 object-cover rounded" />
                                    ` : `
                                        <div class="w-16 h-16 bg-gradient-to-br from-purple-400 to-pink-400 rounded flex items-center justify-center flex-shrink-0">
                                            <svg class="w-8 h-8 text-white opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3"></path>
                                            </svg>
                                        </div>
                                    `}
                                    <div class="flex-1 min-w-0">
                                        <div class="font-semibold text-gray-800 truncate">${escapeHtml(score.song.title)}</div>
                                        <div class="text-sm text-gray-600">${score.difficulty} Lv.${Number(score.level).toFixed(1)}</div>
                                    </div>
                                    <div class="text-right flex-shrink-0">
                                        <div class="font-bold text-lg text-purple-700">Rate: ${score.rate}</div>
                                        <div class="text-sm text-gray-600">${score.score.toLocaleString()}</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        // ÁÆ°ÁêÜÁîªÈù¢
        function renderAdmin(container) {
            if (editingSong) {
                renderSongEditor(container);
            } else {
                container.innerHTML = `
                    <div class="space-y-6">
                        <div class="flex justify-between items-center">
                            <h2 class="text-2xl font-bold text-white">Ê•ΩÊõ≤ÁÆ°ÁêÜ</h2>
                            <button onclick="startAddSong()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg font-semibold transition">
                                + Êñ∞Ë¶èËøΩÂä†
                            </button>
                        </div>

                        <div class="bg-white bg-opacity-90 backdrop-blur-sm rounded-lg p-6">
                            <h3 class="text-xl font-bold text-gray-800 mb-4">ÁôªÈå≤Ê•ΩÊõ≤‰∏ÄË¶ß</h3>
                            ${songs.length === 0 ? `
                                <div class="text-center py-8 text-gray-500">
                                    <svg class="w-16 h-16 mx-auto mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3"></path>
                                    </svg>
                                    <p class="text-lg">Ê•ΩÊõ≤„ÅåÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì</p>
                                    <p class="text-sm mt-2">„ÄåÊñ∞Ë¶èËøΩÂä†„Äç„Éú„Çø„É≥„Åã„ÇâÊ•ΩÊõ≤„ÇíËøΩÂä†„Åó„Å¶„Åè„Å†„Åï„ÅÑ</p>
                                </div>
                            ` : `
                                <div class="space-y-2 max-h-96 overflow-y-auto">
                                    ${songs.map(song => `
                                        <div class="flex items-center gap-4 p-3 bg-gray-50 rounded-lg">
                                            ${song.imageUrl ? `
                                                <img src="${song.imageUrl}" alt="${escapeHtml(song.title)}" class="w-16 h-16 object-cover rounded" />
                                            ` : `
                                                <div class="w-16 h-16 bg-gradient-to-br from-purple-400 to-pink-400 rounded flex items-center justify-center flex-shrink-0">
                                                    <svg class="w-8 h-8 text-white opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3"></path>
                                                    </svg>
                                                </div>
                                            `}
                                            <div class="flex-1 min-w-0">
                                                <div class="font-semibold text-gray-800 truncate">${escapeHtml(song.title)}</div>
                                                <div class="text-sm text-gray-600 truncate">${escapeHtml(song.artist)}</div>
                                            </div>
                                            <div class="flex gap-2 flex-shrink-0">
                                                <button onclick='editSong(${JSON.stringify(song).replace(/'/g, "&apos;")})' class="p-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition">
                                                    Á∑®ÈõÜ
                                                </button>
                                                <button onclick="deleteSong('${song.id}')" class="p-2 bg-red-500 hover:bg-red-600 text-white rounded-lg transition">
                                                    ÂâäÈô§
                                                </button>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            `}
                        </div>
                    </div>
                `;
            }
        }

        // Ê•ΩÊõ≤Á∑®ÈõÜÁîªÈù¢
        function renderSongEditor(container) {
            const song = editingSong;
            container.innerHTML = `
                <div class="bg-white bg-opacity-90 backdrop-blur-sm rounded-lg p-6 max-w-3xl mx-auto">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">${song.id ? 'Ê•ΩÊõ≤Á∑®ÈõÜ' : 'Ê•ΩÊõ≤ËøΩÂä†'}</h3>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">„Ç∏„É£„Ç±„ÉÉ„ÉàÁîªÂÉè</label>
                            <div class="flex items-center gap-4">
                                ${song.imageUrl ? `
                                    <img id="previewImage" src="${song.imageUrl}" alt="Preview" class="w-32 h-32 object-cover rounded-lg" />
                                ` : `
                                    <div id="previewImage" class="w-32 h-32 bg-gray-200 rounded-lg flex items-center justify-center flex-shrink-0">
                                        <svg class="w-12 h-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                        </svg>
                                    </div>
                                `}
                                <div class="flex-1">
                                    <input type="file" id="imageInput" accept="image/*" onchange="handleImageSelect(event)" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-purple-50 file:text-purple-700 hover:file:bg-purple-100" />
                                    <p class="text-xs text-gray-500 mt-1">JPG, PNG, GIF (ÊúÄÂ§ß5MB)</p>
                                </div>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Ê•ΩÊõ≤Âêç</label>
                            <input type="text" id="songTitle" value="${escapeHtml(song.title || '')}" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-purple-500" />
                        </div>

                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">„Ç¢„Éº„ÉÜ„Ç£„Çπ„Éà</label>
                            <input type="text" id="songArtist" value="${escapeHtml(song.artist || '')}" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-purple-500" />
                        </div>

                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Èõ£ÊòìÂ∫¶„É¨„Éô„É´</label>
                            <div class="grid grid-cols-2 md:grid-cols-5 gap-3">
                                ${DIFFICULTIES.map((diff, idx) => `
                                    <div>
                                        <label class="block text-xs font-semibold mb-1 ${DIFFICULTY_COLORS[idx]} text-white px-2 py-1 rounded">
                                            ${diff}
                                        </label>
                                        <input type="number" step="0.1" id="diff_${diff}" value="${song.difficulties?.[diff] || ''}" placeholder="Êú™Ë®≠ÂÆö" class="w-full px-3 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-purple-500" />
                                    </div>
                                `).join('')}
                            </div>
                        </div>

                        <div class="flex gap-3">
                            <button onclick="submitSong()" class="flex-1 bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 rounded-lg transition">
                                ‰øùÂ≠ò
                            </button>
                            <button onclick="cancelEditSong()" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 rounded-lg transition">
                                „Ç≠„É£„É≥„Çª„É´
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // ÁîªÂÉèÈÅ∏Êäû„Éè„É≥„Éâ„É©„Éº
        window.handleImageSelect = (event) => {
            const file = event.target.files[0];
            if (!file) return;

            // „Éï„Ç°„Ç§„É´„Çµ„Ç§„Ç∫„ÉÅ„Çß„ÉÉ„ÇØÔºà5MBÔºâ
            if (file.size > 5 * 1024 * 1024) {
                alert('ÁîªÂÉè„Éï„Ç°„Ç§„É´„ÅØ5MB‰ª•‰∏ã„Å´„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                event.target.value = '';
                return;
            }

            // „Éó„É¨„Éì„É•„ÉºË°®Á§∫
            const reader = new FileReader();
            reader.onload = (e) => {
                const preview = document.getElementById('previewImage');
                if (preview.tagName === 'IMG') {
                    preview.src = e.target.result;
                } else {
                    preview.outerHTML = `<img id="previewImage" src="${e.target.result}" alt="Preview" class="w-32 h-32 object-cover rounded-lg" />`;
                }
            };
            reader.readAsDataURL(file);

            uploadedImageFile = file;
        };

        // „Ç∞„É≠„Éº„Éê„É´Èñ¢Êï∞
        window.selectSong = (songId) => {
            selectedSong = songs.find(s => s.id === songId);
            renderCurrentPage();
        };

        window.selectDifficulty = (diff, level) => {
            window.selectedDifficulty = diff;
            document.getElementById('levelInput').value = Number(level).toFixed(1);
            document.getElementById('scoreInputs').classList.remove('hidden');
            
            DIFFICULTIES.forEach(d => {
                const btn = document.getElementById(`diff_${d}`);
                if (btn) {
                    if (d === diff) {
                        btn.classList.remove('bg-opacity-50');
                        btn.classList.add('bg-opacity-100');
                    } else {
                        btn.classList.remove('bg-opacity-100');
                        btn.classList.add('bg-opacity-50');
                    }
                }
            });
        };

        window.submitScore = () => {
            const score = document.getElementById('scoreInput').value;
            const level = document.getElementById('levelInput').value;
            if (!window.selectedDifficulty || !score || !level) {
                alert('„Åô„Åπ„Å¶„ÅÆÈ†ÖÁõÆ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }
            saveScore(selectedSong.id, window.selectedDifficulty, score, level);
        };

        window.editSong = (song) => {
            editingSong = song;
            uploadedImageFile = null;
            renderCurrentPage();
        };

        window.cancelEditSong = () => {
            editingSong = null;
            uploadedImageFile = null;
            renderCurrentPage();
        };

        window.submitSong = async () => {
            const title = document.getElementById('songTitle').value;
            const artist = document.getElementById('songArtist').value;
            
            if (!title || !artist) {
                alert('„Çø„Ç§„Éà„É´„Å®„Ç¢„Éº„ÉÜ„Ç£„Çπ„Éà„ÅØÂøÖÈ†à„Åß„Åô');
                return;
            }

            const difficulties = {};
            DIFFICULTIES.forEach(diff => {
                const value = document.getElementById(`diff_${diff}`).value;
                if (value) difficulties[diff] = parseFloat(value);
            });

            // ‰øùÂ≠ò‰∏≠„É°„ÉÉ„Çª„Éº„Ç∏
            if (uploadedImageFile) {
                alert('ÁîªÂÉè„Çí„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ‰∏≠„Åß„Åô„ÄÇ„Åó„Å∞„Çâ„Åè„ÅäÂæÖ„Å°„Åè„Å†„Åï„ÅÑ...');
            }

            await saveSong({
                ...editingSong,
                title,
                artist,
                difficulties
            });
        };

        window.deleteSong = deleteSong;
        window.renderCurrentPage = renderCurrentPage;

        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text?.toString().replace(/[&<>"']/g, m => map[m]) || '';
        }

        // ÂàùÊúüÂåñ
        initFirebase();

        // „Çø„ÉñÂàá„ÇäÊõø„ÅàÈñ¢Êï∞„Çí„Ç∞„É≠„Éº„Éê„É´„Å´ÂÖ¨Èñã
        window.switchPage = switchPage;
    </script>
</head>
<body class="min-h-screen bg-gradient-to-br from-purple-900 via-blue-900 to-indigo-900">
    <!-- „É≠„Éº„Éá„Ç£„É≥„Ç∞ÁîªÈù¢ -->
    <div id="loading" class="min-h-screen flex items-center justify-center">
        <div class="text-white text-2xl">„É≠„Ç∞„Ç§„É≥‰∏≠...</div>
    </div>

    <!-- „É°„Ç§„É≥„Ç¢„Éó„É™ -->
    <div id="app" class="hidden">
        <!-- „Éò„ÉÉ„ÉÄ„Éº -->
        <div class="bg-black bg-opacity-50 backdrop-blur-sm border-b border-white border-opacity-20">
            <div class="max-w-7xl mx-auto px-4 py-4">
                <div class="flex items-center justify-between flex-wrap gap-4">
                    <div>
                        <h1 class="text-2xl md:text-3xl font-bold text-white flex items-center gap-2">
                            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3"></path>
                            </svg>
                            Score Manager
                        </h1>
                        <div id="userIdDisplay" class="mt-2"></div>
                    </div>
                    <div class="flex gap-2 flex-wrap">
                        <button id="scoreTab" onclick="switchPage('score')" class="tab-btn px-4 py-2 rounded-lg font-semibold transition bg-white text-purple-900">
                            „Çπ„Ç≥„Ç¢ÁôªÈå≤
                        </button>
                        <button id="statsTab" onclick="switchPage('stats')" class="tab-btn px-4 py-2 rounded-lg font-semibold transition bg-white bg-opacity-20 text-white hover:bg-opacity-30">
                            Áµ±Ë®à
                        </button>
                        <button id="adminTab" onclick="switchPage('admin')" class="tab-btn hidden px-4 py-2 rounded-lg font-semibold transition bg-white bg-opacity-20 text-white hover:bg-opacity-30">
                            ÁÆ°ÁêÜ
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- „Ç≥„É≥„ÉÜ„É≥„ÉÑ„Ç®„É™„Ç¢ -->
        <div class="max-w-7xl mx-auto px-4 py-8">
            <div id="content"></div>
        </div>
    </div>
</body>
</html>
