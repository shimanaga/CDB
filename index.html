<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>音楽ゲームスコア管理システム</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, doc, setDoc, getDoc, getDocs, query, where, deleteDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js';

        // Firebase設定（あなたの設定値に置き換えてください）
        const firebaseConfig = {
            apiKey: "AIzaSyBrlOj1D_Tkk16l9_T_gHcGgGvgjXrkg2k",
            authDomain: "tcdb-de19d.firebaseapp.com",
            projectId: "tcdb-de19d",
            storageBucket: "tcdb-de19d.firebasestorage.app",
            messagingSenderId: "914426625733",
            appId: "1:914426625733:web:1d167f8648e40268a2baac",
            measurementId: "G-W8N9ZDFT6Y"
        };

        const DIFFICULTIES = ['NORMAL', 'HARD', 'MASTER', 'INSANITY', 'RAVAGE'];
        const DIFFICULTY_COLORS = ['bg-sky-400', 'bg-amber-500', 'bg-purple-600', 'bg-slate-400', 'bg-red-600'];

        let app, auth, db, storage, currentUser, isAdmin = false;
        let songs = [], userScores = {};
        let currentPage = 'score';
        let selectedSong = null;
        let editingSong = null;
        let uploadedImageFile = null;

        // Firebase初期化
        async function initFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                storage = getStorage(app);

                // グローバルに公開（デバッグ用）
                window.auth = auth;
                window.db = db;
                window.storage = storage;

                // 匿名認証
                await signInAnonymously(auth);

                // 認証状態の監視
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        currentUser = user;
                        window.currentUser = user; // グローバルに公開
                        
                        // ユーザーIDを表示
                        displayUserId(user.uid);
                        
                        document.getElementById('loading').classList.add('hidden');
                        document.getElementById('app').classList.remove('hidden');
                        await loadUserData(user.uid);
                        await loadSongs();
                        renderCurrentPage();
                    }
                });
            } catch (error) {
                console.error("Firebase初期化エラー:", error);
                document.getElementById('loading').innerHTML = `
                    <div class="text-white text-center">
                        <div class="text-2xl mb-4">Firebase初期化エラー</div>
                        <div class="text-sm bg-red-500 bg-opacity-20 p-4 rounded-lg max-w-2xl mx-auto">
                            ${error.message}
                        </div>
                        <div class="text-sm mt-4">firebaseConfigを確認してください</div>
                    </div>
                `;
            }
        }

        // ユーザーID表示
        function displayUserId(uid) {
            const display = document.getElementById('userIdDisplay');
            if (display) {
                display.innerHTML = `
                    <div class="bg-yellow-500 bg-opacity-20 px-3 py-2 rounded-lg">
                        <span class="text-yellow-300 text-xs">プレイヤーID:</span>
                        <span class="text-yellow-100 font-mono text-sm ml-2">${uid}</span>
                        <button onclick="copyUserId('${uid}')" class="ml-2 bg-yellow-600 hover:bg-yellow-700 text-white text-xs px-2 py-1 rounded">
                            コピー
                        </button>
                    </div>
                `;
            }
        }

        // ユーザーIDコピー
        window.copyUserId = (uid) => {
            navigator.clipboard.writeText(uid).then(() => {
                alert('ユーザーIDをコピーしました！\n\nFirestoreの users コレクションで\nこのIDをドキュメントIDとして使用し、\nisAdmin: true を設定してください。');
            });
        };

        // 楽曲データ読み込み
        async function loadSongs() {
            try {
                const songsCol = collection(db, 'songs');
                const songSnapshot = await getDocs(songsCol);
                songs = songSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                songs.sort((a, b) => a.title.localeCompare(b.title, 'ja'));
                window.songs = songs; // グローバルに公開
            } catch (error) {
                console.error("楽曲読み込みエラー:", error);
            }
        }

        // ユーザーデータ読み込み（サブコレクション構造に変更）
        async function loadUserData(userId) {
            try {
                const userDoc = await getDoc(doc(db, 'users', userId));
                if (userDoc.exists() && userDoc.data().isAdmin) {
                    isAdmin = true;
                    window.isAdmin = true;
                    document.getElementById('adminTab').classList.remove('hidden');
                }

                // サブコレクションから直接スコアを取得（高速）
                const scoresCol = collection(db, 'users', userId, 'scores');
                const scoreSnapshot = await getDocs(scoresCol);
                userScores = {};
                scoreSnapshot.docs.forEach(doc => {
                    userScores[doc.id] = doc.data();
                });
                window.userScores = userScores;
                console.log(`${scoreSnapshot.docs.length}件のスコアを読み込みました`);
            } catch (error) {
                console.error("ユーザーデータ読み込みエラー:", error);
            }
        }

        // 画像アップロード
        async function uploadImage(file, songId) {
            try {
                const timestamp = Date.now();
                const fileName = `songs/${songId}_${timestamp}.${file.name.split('.').pop()}`;
                const storageRef = ref(storage, fileName);
                
                await uploadBytes(storageRef, file);
                const downloadURL = await getDownloadURL(storageRef);
                
                return { url: downloadURL, path: fileName };
            } catch (error) {
                console.error("画像アップロードエラー:", error);
                throw error;
            }
        }

        // 古い画像削除
        async function deleteOldImage(imagePath) {
            if (!imagePath) return;
            try {
                const imageRef = ref(storage, imagePath);
                await deleteObject(imageRef);
            } catch (error) {
                console.error("画像削除エラー:", error);
            }
        }

        // 単曲レート計算
        function calculateRate(score, level) {
            const baseRate = level;
            const scoreRate = score >= 999000 ? (level + (2 + (score - 999000) / 10000)) / 34 :
                             score >= 995000 ? (level + (1.5 + (score - 995000) / 8000)) / 34 :
                             score >= 990000 ? (level + (1 + (score - 990000) / 10000)) / 34 :
                             score >= 970000 ? (level + (score - 970000) / 20000) / 34 :
                             score >= 800000 ? (level * (score - 800000) / 170000) / 34 : 0;
            return (scoreRate).toFixed(3);
        }

        // スコア保存（サブコレクション構造に変更）
        async function saveScore(songId, difficulty, score, level) {
            const rate = calculateRate(parseInt(score), parseFloat(level));
            const scoreId = `${songId}_${difficulty}`;

            try {
                // サブコレクションに保存（users/{userId}/scores/{scoreId}）
                await setDoc(doc(db, 'users', currentUser.uid, 'scores', scoreId), {
                    songId,
                    difficulty,
                    score: parseInt(score),
                    level: parseFloat(level),
                    rate: parseFloat(rate),
                    timestamp: new Date().toISOString()
                });

                userScores[scoreId] = { songId, difficulty, score: parseInt(score), level: parseFloat(level), rate: parseFloat(rate) };
                alert('スコアを保存しました！');
                selectedSong = null;
                renderCurrentPage();
            } catch (error) {
                console.error("スコア保存エラー:", error);
                alert('スコアの保存に失敗しました');
            }
        }

        // スコア削除
        async function deleteScore(scoreId) {
            if (!confirm('このスコアを削除しますか？')) return;
            
            try {
                await deleteDoc(doc(db, 'users', currentUser.uid, 'scores', scoreId));
                delete userScores[scoreId];
                alert('スコアを削除しました');
                renderCurrentPage();
            } catch (error) {
                console.error("スコア削除エラー:", error);
                alert('スコアの削除に失敗しました');
            }
        }

        // 楽曲保存
        async function saveSong(songData) {
            const songId = songData.id || `song_${Date.now()}`;
            let imageUrl = songData.imageUrl || '';
            let imagePath = songData.imagePath || '';

            try {
                // 新しい画像がアップロードされた場合
                if (uploadedImageFile) {
                    console.log('画像アップロード開始...');
                    
                    // 古い画像を削除
                    if (songData.imagePath) {
                        try {
                            await deleteOldImage(songData.imagePath);
                        } catch (error) {
                            console.warn('古い画像の削除に失敗しました:', error);
                        }
                    }
                    
                    // 新しい画像をアップロード
                    try {
                        const imageData = await uploadImage(uploadedImageFile, songId);
                        imageUrl = imageData.url;
                        imagePath = imageData.path;
                        console.log('画像アップロード完了:', imageUrl);
                    } catch (error) {
                        console.error('画像アップロードエラー:', error);
                        if (error.code === 'storage/unauthorized') {
                            throw new Error('Firebase Storageが有効化されていません。Firebase Consoleで Storage を有効化してください。');
                        }
                        throw new Error('画像のアップロードに失敗しました: ' + error.message);
                    }
                }

                // Firestoreに保存
                console.log('楽曲データ保存開始...');
                await setDoc(doc(db, 'songs', songId), {
                    title: songData.title,
                    artist: songData.artist,
                    difficulties: songData.difficulties,
                    imageUrl: imageUrl,
                    imagePath: imagePath,
                    createdAt: songData.createdAt || new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                });
                console.log('楽曲データ保存完了');

                await loadSongs();
                editingSong = null;
                uploadedImageFile = null;
                alert('楽曲を保存しました！');
                renderCurrentPage();
            } catch (error) {
                console.error("楽曲保存エラー:", error);
                throw error;
            }
        }

        // 楽曲削除
        async function deleteSong(songId) {
            if (!confirm('本当に削除しますか？')) return;

            try {
                const song = songs.find(s => s.id === songId);
                
                // 画像も削除
                if (song && song.imagePath) {
                    await deleteOldImage(song.imagePath);
                }
                
                await deleteDoc(doc(db, 'songs', songId));
                await loadSongs();
                alert('楽曲を削除しました');
                renderCurrentPage();
            } catch (error) {
                console.error("楽曲削除エラー:", error);
            }
        }

        // ページ切り替え
        function switchPage(page) {
            currentPage = page;
            selectedSong = null;
            editingSong = null;
            uploadedImageFile = null;
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('bg-white', 'text-purple-900');
                btn.classList.add('bg-white', 'bg-opacity-20', 'text-white');
            });
            document.getElementById(`${page}Tab`).classList.remove('bg-opacity-20');
            document.getElementById(`${page}Tab`).classList.add('bg-white', 'text-purple-900');
            renderCurrentPage();
        }

        // 楽曲追加開始
        window.startAddSong = () => {
            editingSong = {};
            uploadedImageFile = null;
            renderCurrentPage();
        };

        // ページレンダリング
        function renderCurrentPage() {
            const content = document.getElementById('content');
            
            if (currentPage === 'score') {
                if (selectedSong) {
                    renderScoreEntry(content);
                } else {
                    renderSongList(content);
                }
            } else if (currentPage === 'stats') {
                renderStatistics(content);
            } else if (currentPage === 'admin') {
                renderAdmin(content);
            }
        }

        // 楽曲リスト表示
        function renderSongList(container) {
            const searchTerm = document.getElementById('searchInput')?.value.toLowerCase() || '';
            const filteredSongs = songs.filter(song =>
                song.title.toLowerCase().includes(searchTerm) ||
                song.artist.toLowerCase().includes(searchTerm)
            );

            container.innerHTML = `
                <div class="mb-6">
                    <div class="relative">
                        <svg class="absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400 w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                        <input
                            type="text"
                            id="searchInput"
                            placeholder="楽曲名やアーティスト名で検索..."
                            class="w-full pl-12 pr-4 py-3 rounded-lg bg-white bg-opacity-90 backdrop-blur-sm text-gray-800 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-purple-500"
                            oninput="renderCurrentPage()"
                        />
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    ${filteredSongs.map(song => `
                        <div onclick="selectSong('${song.id}')" class="bg-white bg-opacity-90 backdrop-blur-sm rounded-lg overflow-hidden cursor-pointer hover:bg-opacity-100 transition transform hover:scale-105 shadow-lg">
                            ${song.imageUrl ? `
                                <div class="w-full h-48 bg-gray-200 overflow-hidden">
                                    <img src="${song.imageUrl}" alt="${escapeHtml(song.title)}" class="w-full h-full object-cover" />
                                </div>
                            ` : `
                                <div class="w-full h-48 bg-gradient-to-br from-purple-400 to-pink-400 flex items-center justify-center">
                                    <svg class="w-20 h-20 text-white opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3"></path>
                                    </svg>
                                </div>
                            `}
                            <div class="p-4">
                                <h3 class="font-bold text-lg text-gray-800 mb-1 truncate">${escapeHtml(song.title)}</h3>
                                <p class="text-sm text-gray-600 mb-3 truncate">${escapeHtml(song.artist)}</p>
                                <div class="flex flex-wrap gap-1">
                                    ${DIFFICULTIES.map((diff, idx) => 
                                        song.difficulties?.[diff] ? 
                                        `<span class="${DIFFICULTY_COLORS[idx]} text-white text-xs px-2 py-1 rounded font-semibold">${diff}</span>` 
                                        : ''
                                    ).join('')}
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // スコア入力画面
        function renderScoreEntry(container) {
            const song = selectedSong;
            container.innerHTML = `
                <div class="bg-white bg-opacity-90 backdrop-blur-sm rounded-lg p-6 max-w-2xl mx-auto">
                    <button onclick="selectedSong = null; renderCurrentPage();" class="mb-4 text-purple-700 hover:text-purple-900 font-semibold">
                        ← 戻る
                    </button>
                    
                    ${song.imageUrl ? `
                        <div class="mb-4 rounded-lg overflow-hidden">
                            <img src="${song.imageUrl}" alt="${escapeHtml(song.title)}" class="w-full h-64 object-cover" />
                        </div>
                    ` : ''}
                    
                    <h2 class="text-2xl font-bold text-gray-800 mb-2">${escapeHtml(song.title)}</h2>
                    <p class="text-gray-600 mb-6">${escapeHtml(song.artist)}</p>

                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">難易度を選択</label>
                            <div class="flex flex-wrap gap-2" id="difficultyButtons">
                                ${DIFFICULTIES.map((diff, idx) => 
                                    song.difficulties?.[diff] ? 
                                    `<button onclick="selectDifficulty('${diff}', ${song.difficulties[diff]})" class="${DIFFICULTY_COLORS[idx]} bg-opacity-50 hover:bg-opacity-100 text-white px-4 py-2 rounded-lg font-semibold transition" id="diff_${diff}">
                                        ${diff} ${Number(song.difficulties[diff]).toFixed(1)}
                                    </button>` 
                                    : ''
                                ).join('')}
                            </div>
                        </div>

                        <div id="scoreInputs" class="hidden space-y-4">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">スコア</label>
                                <input type="number" id="scoreInput" placeholder="1000000" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-purple-500" />
                            </div>

                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">譜面レベル</label>
                                <input type="number" step="0.1" id="levelInput" placeholder="12.5" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-purple-500" />
                            </div>

                            <button onclick="submitScore()" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 rounded-lg transition">
                                スコアを保存
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // 統計画面
        function renderStatistics(container) {
            const rates = Object.values(userScores).map(s => parseFloat(s.rate));
            const topRates = [...rates].sort((a, b) => b - a).slice(0, 40);
            const totalRate = topRates.length > 0 ? topRates.reduce((a, b) => a + b, 0).toFixed(4) : '0.000';
            const avgRate = topRates.length > 0 ? (topRates.reduce((a, b) => a + b, 0) / topRates.length).toFixed(3) : '0.000';

            const songMap = Object.fromEntries(songs.map(s => [s.id, s]));
            const scoresWithSongInfo = Object.entries(userScores)
                .map(([id, score]) => ({ ...score, song: songMap[score.songId], scoreId: id }))
                .filter(s => s.song)
                .sort((a, b) => parseFloat(b.rate) - parseFloat(a.rate));

            container.innerHTML = `
                <div class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="bg-white bg-opacity-90 backdrop-blur-sm rounded-lg p-6">
                            <div class="text-sm text-gray-600 mb-1">Rating</div>
                            <div class="text-3xl font-bold text-red-700">${totalRate}</div>
                        </div>
                        <div class="bg-white bg-opacity-90 backdrop-blur-sm rounded-lg p-6">
                            <div class="text-sm text-gray-600 mb-1">平均レート</div>
                            <div class="text-3xl font-bold text-blue-700">${avgRate}</div>
                        </div>
                        <div class="bg-white bg-opacity-90 backdrop-blur-sm rounded-lg p-6">
                            <div class="text-sm text-gray-600 mb-1">登録スコア数</div>
                            <div class="text-3xl font-bold text-purple-700">${Object.keys(userScores).length}</div>
                        </div>
                    </div>

                    <div class="bg-white bg-opacity-90 backdrop-blur-sm rounded-lg p-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">スコア一覧</h3>
                        <div class="space-y-2 max-h-96 overflow-y-auto">
                            ${scoresWithSongInfo.map(score => `
                                <div class="flex items-center gap-4 p-3 bg-gray-50 rounded-lg">
                                    ${score.song.imageUrl ? `
                                        <img src="${score.song.imageUrl}" alt="${escapeHtml(score.song.title)}" class="w-16 h-16 object-cover rounded" />
                                    ` : `
                                        <div class="w-16 h-16 bg-gradient-to-br from-purple-400 to-pink-400 rounded flex items-center justify-center flex-shrink-0">
                                            <svg class="w-8 h-8 text-white opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3"></path>
                                            </svg>
                                        </div>
                                    `}
                                    <div class="flex-1 min-w-0">
                                        <div class="font-semibold text-gray-800 truncate">${escapeHtml(score.song.title)}</div>
                                        <div class="text-sm text-gray-600">${score.difficulty} ${Number(score.level).toFixed(1)}</div>
                                    </div>
                                    <div class="text-right flex-shrink-0">
                                        <div class="font-bold text-lg text-purple-700">Rate: ${score.rate}</div>
                                        <div class="text-sm text-gray-600">${score.score.toLocaleString()}</div>
                                    </div>
                                    <button onclick="deleteScore('${score.scoreId}')" class="p-2 bg-red-500 hover:bg-red-600 text-white rounded-lg transition flex-shrink-0" title="削除">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                        </svg>
                                    </button>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        // 管理画面
        function renderAdmin(container) {
            if (editingSong) {
                renderSongEditor(container);
            } else {
                container.innerHTML = `
                    <div class="space-y-6">
                        <div class="flex justify-between items-center">
                            <h2 class="text-2xl font-bold text-white">楽曲管理</h2>
                            <button onclick="startAddSong()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg font-semibold transition">
                                + 新規追加
                            </button>
                        </div>

                        <div class="bg-white bg-opacity-90 backdrop-blur-sm rounded-lg p-6">
                            <h3 class="text-xl font-bold text-gray-800 mb-4">登録楽曲一覧</h3>
                            ${songs.length === 0 ? `
                                <div class="text-center py-8 text-gray-500">
                                    <svg class="w-16 h-16 mx-auto mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3"></path>
                                    </svg>
                                    <p class="text-lg">楽曲が登録されていません</p>
                                    <p class="text-sm mt-2">「新規追加」ボタンから楽曲を追加してください</p>
                                </div>
                            ` : `
                                <div class="space-y-2 max-h-96 overflow-y-auto">
                                    ${songs.map(song => `
                                        <div class="flex items-center gap-4 p-3 bg-gray-50 rounded-lg">
                                            ${song.imageUrl ? `
                                                <img src="${song.imageUrl}" alt="${escapeHtml(song.title)}" class="w-16 h-16 object-cover rounded" />
                                            ` : `
                                                <div class="w-16 h-16 bg-gradient-to-br from-purple-400 to-pink-400 rounded flex items-center justify-center flex-shrink-0">
                                                    <svg class="w-8 h-8 text-white opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3"></path>
                                                    </svg>
                                                </div>
                                            `}
                                            <div class="flex-1 min-w-0">
                                                <div class="font-semibold text-gray-800 truncate">${escapeHtml(song.title)}</div>
                                                <div class="text-sm text-gray-600 truncate">${escapeHtml(song.artist)}</div>
                                            </div>
                                            <div class="flex gap-2 flex-shrink-0">
                                                <button onclick='editSong(${JSON.stringify(song).replace(/'/g, "&apos;")})' class="p-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition">
                                                    編集
                                                </button>
                                                <button onclick="deleteSong('${song.id}')" class="p-2 bg-red-500 hover:bg-red-600 text-white rounded-lg transition">
                                                    削除
                                                </button>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            `}
                        </div>
                    </div>
                `;
            }
        }

        // 楽曲編集画面
        function renderSongEditor(container) {
            const song = editingSong;
            container.innerHTML = `
                <div class="bg-white bg-opacity-90 backdrop-blur-sm rounded-lg p-6 max-w-3xl mx-auto">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">${song.id ? '楽曲編集' : '楽曲追加'}</h3>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">ジャケット画像</label>
                            <div class="flex items-center gap-4">
                                ${song.imageUrl ? `
                                    <img id="previewImage" src="${song.imageUrl}" alt="Preview" class="w-32 h-32 object-cover rounded-lg" />
                                ` : `
                                    <div id="previewImage" class="w-32 h-32 bg-gray-200 rounded-lg flex items-center justify-center flex-shrink-0">
                                        <svg class="w-12 h-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                        </svg>
                                    </div>
                                `}
                                <div class="flex-1">
                                    <input type="file" id="imageInput" accept="image/*" onchange="handleImageSelect(event)" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-purple-50 file:text-purple-700 hover:file:bg-purple-100" />
                                    <p class="text-xs text-gray-500 mt-1">JPG, PNG, GIF (最大5MB)</p>
                                </div>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">楽曲名</label>
                            <input type="text" id="songTitle" value="${escapeHtml(song.title || '')}" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-purple-500" />
                        </div>

                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">アーティスト</label>
                            <input type="text" id="songArtist" value="${escapeHtml(song.artist || '')}" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-purple-500" />
                        </div>

                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">難易度レベル</label>
                            <div class="grid grid-cols-2 md:grid-cols-5 gap-3">
                                ${DIFFICULTIES.map((diff, idx) => `
                                    <div>
                                        <label class="block text-xs font-semibold mb-1 ${DIFFICULTY_COLORS[idx]} text-white px-2 py-1 rounded">
                                            ${diff}
                                        </label>
                                        <input type="number" step="0.1" id="diff_${diff}" value="${song.difficulties?.[diff] || ''}" placeholder="未設定" class="w-full px-3 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-purple-500" />
                                    </div>
                                `).join('')}
                            </div>
                        </div>

                        <div class="flex gap-3">
                            <button id="saveSongButton" onclick="submitSong()" class="flex-1 bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 rounded-lg transition disabled:opacity-50 disabled:cursor-not-allowed">
                                保存
                            </button>
                            <button onclick="cancelEditSong()" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 rounded-lg transition">
                                キャンセル
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // 画像選択ハンドラー
        window.handleImageSelect = (event) => {
            const file = event.target.files[0];
            if (!file) return;

            // ファイルサイズチェック（5MB）
            if (file.size > 5 * 1024 * 1024) {
                alert('画像ファイルは5MB以下にしてください');
                event.target.value = '';
                return;
            }

            // プレビュー表示
            const reader = new FileReader();
            reader.onload = (e) => {
                const preview = document.getElementById('previewImage');
                if (preview.tagName === 'IMG') {
                    preview.src = e.target.result;
                } else {
                    preview.outerHTML = `<img id="previewImage" src="${e.target.result}" alt="Preview" class="w-32 h-32 object-cover rounded-lg" />`;
                }
            };
            reader.readAsDataURL(file);

            uploadedImageFile = file;
        };

        // グローバル関数
        window.selectSong = (songId) => {
            selectedSong = songs.find(s => s.id === songId);
            renderCurrentPage();
        };

        window.selectDifficulty = (diff, level) => {
            window.selectedDifficulty = diff;
            document.getElementById('levelInput').value = Number(level).toFixed(1);
            document.getElementById('scoreInputs').classList.remove('hidden');
            
            DIFFICULTIES.forEach(d => {
                const btn = document.getElementById(`diff_${d}`);
                if (btn) {
                    if (d === diff) {
                        btn.classList.remove('bg-opacity-50');
                        btn.classList.add('bg-opacity-100');
                    } else {
                        btn.classList.remove('bg-opacity-100');
                        btn.classList.add('bg-opacity-50');
                    }
                }
            });
        };

        window.submitScore = () => {
            const score = document.getElementById('scoreInput').value;
            const level = document.getElementById('levelInput').value;
            if (!window.selectedDifficulty || !score || !level) {
                alert('すべての項目を入力してください');
                return;
            }
            saveScore(selectedSong.id, window.selectedDifficulty, score, level);
        };

        window.editSong = (song) => {
            editingSong = song;
            uploadedImageFile = null;
            renderCurrentPage();
        };

        window.cancelEditSong = () => {
            editingSong = null;
            uploadedImageFile = null;
            renderCurrentPage();
        };

        window.submitSong = async () => {
            const title = document.getElementById('songTitle').value;
            const artist = document.getElementById('songArtist').value;
            
            if (!title || !artist) {
                alert('タイトルとアーティストは必須です');
                return;
            }

            const difficulties = {};
            DIFFICULTIES.forEach(diff => {
                const value = document.getElementById(`diff_${diff}`).value;
                if (value) difficulties[diff] = parseFloat(value);
            });

            // 難易度が1つも設定されていない場合の警告
            if (Object.keys(difficulties).length === 0) {
                if (!confirm('難易度が1つも設定されていません。このまま保存しますか？')) {
                    return;
                }
            }

            // 保存ボタンを無効化（二重送信防止）
            const saveButton = document.getElementById('saveSongButton');
            if (saveButton) {
                saveButton.disabled = true;
                saveButton.textContent = '保存中...';
            }

            try {
                await saveSong({
                    ...editingSong,
                    title,
                    artist,
                    difficulties
                });
            } catch (error) {
                console.error('保存エラー:', error);
                alert('保存に失敗しました: ' + error.message);
                // ボタンを元に戻す
                if (saveButton) {
                    saveButton.disabled = false;
                    saveButton.textContent = '保存';
                }
            }
        };

        window.deleteSong = deleteSong;
        window.deleteScore = deleteScore;
        window.renderCurrentPage = renderCurrentPage;

        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text?.toString().replace(/[&<>"']/g, m => map[m]) || '';
        }

        // 初期化
        initFirebase();

        // タブ切り替え関数をグローバルに公開
        window.switchPage = switchPage;
    </script>
</head>
<body class="min-h-screen bg-gradient-to-br from-purple-900 via-blue-900 to-indigo-900">
    <!-- ローディング画面 -->
    <div id="loading" class="min-h-screen flex items-center justify-center">
        <div class="text-white text-2xl">ログイン中...</div>
    </div>

    <!-- メインアプリ -->
    <div id="app" class="hidden">
        <!-- ヘッダー -->
        <div class="bg-black bg-opacity-50 backdrop-blur-sm border-b border-white border-opacity-20">
            <div class="max-w-7xl mx-auto px-4 py-4">
                <div class="flex items-center justify-between flex-wrap gap-4">
                    <div>
                        <h1 class="text-2xl md:text-3xl font-bold text-white flex items-center gap-2">
                            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3"></path>
                            </svg>
                            TAKUMI³ Player DB
                        </h1>
                        <div id="userIdDisplay" class="mt-2"></div>
                    </div>
                    <div class="flex gap-2 flex-wrap">
                        <button id="scoreTab" onclick="switchPage('score')" class="tab-btn px-4 py-2 rounded-lg font-semibold transition bg-white text-purple-900">
                            スコア登録
                        </button>
                        <button id="statsTab" onclick="switchPage('stats')" class="tab-btn px-4 py-2 rounded-lg font-semibold transition bg-white bg-opacity-20 text-white hover:bg-opacity-30">
                            統計
                        </button>
                        <button id="adminTab" onclick="switchPage('admin')" class="tab-btn hidden px-4 py-2 rounded-lg font-semibold transition bg-white bg-opacity-20 text-white hover:bg-opacity-30">
                            管理
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- コンテンツエリア -->
        <div class="max-w-7xl mx-auto px-4 py-8">
            <div id="content"></div>
        </div>
    </div>
</body>
</html>
